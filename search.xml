<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>VS2019和QT联合开发</title>
      <link href="/2023/09/20/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/"/>
      <url>/2023/09/20/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<center>qt自带的Creator已经带有非常强大的功能，特别是在编辑界面以及界面中事件与代码的联动非常方便，但是促使我改变该种编程方式的原因在于qt原有的编辑器在代码调试方面远远不如visual studio，而且经常出现无响应的情况，这对于算法的调试是及其不友好的。</center><span id="more"></span><h2 id="QT开发环境"><a href="#QT开发环境" class="headerlink" title="QT开发环境"></a>QT开发环境</h2><blockquote><p>QT的版本很多，本文使用的版本为5.12.2，系统环境为Windows11。参考资料如下所示，但本文机器上很久之前已经安装完成了，不确定方法是否有用，但流程应该类似。</p><p>参考资料：<a href="https://blog.csdn.net/qq_43125185/article/details/117426594">QT 5.15 最新安装指南（针对不同系统）</a></p></blockquote><h3 id="QT安装器"><a href="#QT安装器" class="headerlink" title="QT安装器"></a>QT安装器</h3><blockquote><p>QT离线安装官网：<a href="https://download.qt.io/official_releases/qt/5.15/5.15.2/">https://download.qt.io/official_releases/qt/5.15/5.15.2/</a></p></blockquote><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230920164812716.png" alt="image-20230920164812716"></p><blockquote><p>Qt在线安装官网：<a href="https://download.qt.io/official_releases/online_installers/">https://download.qt.io/official_releases/online_installers/</a></p></blockquote><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230920165008101.png" alt="image-20230920165008101"></p><h3 id="Windows安装指南"><a href="#Windows安装指南" class="headerlink" title="Windows安装指南"></a>Windows安装指南</h3><ol><li><p>进入在线安装程序，注册或登录账户，安装过程中要注意网络情况或者qt的安装源。</p></li><li><p>自定义安装选择需要的qt版本及组件即可。</p></li></ol><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926102025872.png" alt="image-20230926102025872"></p><h2 id="Visual-Studio开发环境"><a href="#Visual-Studio开发环境" class="headerlink" title="Visual Studio开发环境"></a>Visual Studio开发环境</h2><blockquote><p>本文中使用的环境为Vs2019，自行安装。</p></blockquote><h3 id="下载qt插件"><a href="#下载qt插件" class="headerlink" title="下载qt插件"></a>下载qt插件</h3><blockquote><p>在qt插件下载中可以选择进入vs的扩展管理中进行在线下载安装，同时也可以选择在网站上下载后再进行离线安装，由于vs在线下载的网络不够稳定，本文中选择离线安装方式，下载的插件版本为2.8.0</p><p>插件下载地址：<a href="http://download.qt.io/development_releases/vsaddin/">http://download.qt.io/development_releases/vsaddin/</a></p></blockquote><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926103326376.png" alt="image-20230926103326376"></p><h3 id="配置qt版本"><a href="#配置qt版本" class="headerlink" title="配置qt版本"></a>配置qt版本</h3><p>一般而言，qt的插件设置位于扩展板块下的QT VS Tools中，但是也有的版本会出现在vs的总标题栏中，自行找到该配置文件，选择Options进行配置。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926103451907.png" alt="image-20230926103451907"></p><p>选择qt的Versions进行版本配置，使用qt相对应的版本，本文中选择qt的msvc2019与vs版本对应。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926103826089.png" alt="image-20230926103826089"></p><h3 id="创建一个qt项目"><a href="#创建一个qt项目" class="headerlink" title="创建一个qt项目"></a>创建一个qt项目</h3><p>安装完vs中的qt插件后，选择新建项目，即可在列表中查看到qt项目的配置。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926104255244.png" alt="image-20230926104255244"></p><p>选择对应的平台与debug模式。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926104613342.png" alt="image-20230926104613342"></p><p>创建合适的基类。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926104754435.png" alt="image-20230926104754435"></p><h3 id="编辑ui"><a href="#编辑ui" class="headerlink" title="编辑ui"></a>编辑ui</h3><p>在很多情况下，直接双击文件中ui文件进行界面编辑时会发生闪退，不清楚导致其发生的原因，但可以通过指定默认打开软件为Creator来解决该问题。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926105131948.png" alt="image-20230926105131948"></p><p>选择qt中Creator对应的路径，将其设为默认值。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926105401413.png" alt="image-20230926105401413"></p><h3 id="更新ui"><a href="#更新ui" class="headerlink" title="更新ui"></a>更新ui</h3><p>如果使用vs与qt creator的方式对页面进行编辑，会发现不论是槽函数自动跳转也好，还是页面控件的更新也好，都不是特别方便，尤其是页面控件的更新会存在迟滞性，如果不重新打开项目就无法在代码提示中找到你刚刚添加的控件。当然，如果手动输入控件，无视vs的报错，仍然可以运行，但是会非常别扭且不方便。在网上找到的方法大多是重新编译ui文件，再右键项目重新扫描解决方案，但该方法直接使用会发现仍无法更新，其原因经过我分析可能是代码提示并不能很好的找到手动编译ui生成的头文件，其保存目录如下。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926110145885.png" alt="image-20230926110145885"></p><p>而在项目头文件中，其寻址方式如下。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926110241698.png" alt="image-20230926110241698"></p><p>通过该方法寻址中间隔了一个<code>uic</code>文件夹，所以我怀疑在程序运行时能够正确找到该文件，但是代码提示无法正确找到该文件，或者说无法及时更新。</p><p>因此，在该部分本文选择改变ui生成头文件的路径，使其直接生成到项目根目录中，右键ui文件选择属性，将<code>uic</code>的<code>Output Directory</code>改为根目录，此时编译完成后的头文件能够直接生成到根目录下，再执行上述的编译与重新扫描解决方案即可更新ui，使代码提示恢复正常。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926110615786.png" alt="image-20230926110615786"></p><h2 id="Qt界面编辑"><a href="#Qt界面编辑" class="headerlink" title="Qt界面编辑"></a>Qt界面编辑</h2><h3 id="qt更改pushButton的图标"><a href="#qt更改pushButton的图标" class="headerlink" title="qt更改pushButton的图标"></a>qt更改pushButton的图标</h3><blockquote><p>在该步骤中我需要增加一个切换文件夹图标的功能，使用原有的<code>pushButton</code>会感觉非常别扭，因此，我下载了一个更符合视觉直观感受的图标来代替<code>pushButton</code>。</p></blockquote><p>添加新项<code>Resource.qrc</code>用来管理资源文件。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926111547492.png" alt="image-20230926111547492"></p><p>像<code>Resource.qrc</code>中添加对应的图标文件，文件路径设置如下所示。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926111908599.png" alt="image-20230926111908599"></p><p>在qt的cpp中对该资源进行调用，覆盖掉原有的icon。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QIcon toLeftIcon, toRightIcon;</span><br><span class="line">toLeftIcon.<span class="built_in">addFile</span>(<span class="string">&quot;:/image/icons/toLeft.png&quot;</span>);</span><br><span class="line">toRightIcon.<span class="built_in">addFile</span>(<span class="string">&quot;:/image/icons/toRight.png&quot;</span>);</span><br><span class="line">ui.pushButton_T1Left-&gt;<span class="built_in">setIcon</span>(toLeftIcon);</span><br></pre></td></tr></table></figure><p>其在界面中的表示效果如图所示。</p><p><img src="/images/VS2019%E5%92%8CQT%E8%81%94%E5%90%88%E5%BC%80%E5%8F%91/image-20230926112318018.png" alt="image-20230926112318018"></p>]]></content>
      
      
      <categories>
          
          <category> phaseDeflection </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vs </tag>
            
            <tag> QT </tag>
            
            <tag> opencv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cpp命名规范指南</title>
      <link href="/2023/09/15/Cpp%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E6%8C%87%E5%8D%97/"/>
      <url>/2023/09/15/Cpp%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<center>最重要的一致性规则是命名管理。 命名的风格能让我们在不需要去查找类型声明的条件下快速地了解某个名字代表的含义: 类型, 变量, 函数, 常量, 宏, 等等, 甚至. 我们大脑中的模式匹配引擎非常依赖这些命名规则。</center><center>命名规则具有一定随意性, 但相比按个人喜好命名, 一致性更重要, 所以无论你认为它们是否重要, 规则总归是规则.</center><span id="more"></span><blockquote><p>由于在最近的编程过程中，逐渐发现由于代码量过多，导致经常分不清那个变量来自于哪里，作用域是什么样子，经常出现混乱，于是越发感觉到命名规范的重要程度，本文中主要参考<a href="https://zhuanlan.zhihu.com/p/377183341">C++命名规范</a>进行编写，同时也可借鉴<a href="https://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/naming/#">Google开源项目风格指南</a>与<a href="https://developer.aliyun.com/article/855605">C++命名规则&amp;书写规范</a>，但相对于后两者的风格来说，前者的规范更符合我编写代码的习惯。</p></blockquote><h2 id="常见命名法"><a href="#常见命名法" class="headerlink" title="常见命名法"></a>常见命名法</h2><p><strong>匈牙利命名法：</strong>基本原则是：变量名＝属性＋类型＋对象描述，其中每一对象的名称都要求有明确含义，可以取对象名字全称或名字的一部分。命名要基于容易记忆容易理解的原则。保证名字的连贯性是非常重要的。</p><p><strong>Camel命名法：</strong>即骆驼式命名法，原因是采用该命名法的名称看起来就像骆驼的驼峰一样高低起伏。Camel命名法有两种形式：混合使用大小写字母和单词之间加下划线，例如runFast和run_fast都属于Camel命名法。</p><p><strong>Pascal命名法：</strong>与Camel命名法类似，不过Pascal命名法的首字母为大写字母。</p><h2 id="共性规则"><a href="#共性规则" class="headerlink" title="共性规则"></a>共性规则</h2><h3 id="规则1-标识符应简单明了，望文知义"><a href="#规则1-标识符应简单明了，望文知义" class="headerlink" title="规则1 标识符应简单明了，望文知义"></a>规则1 标识符应简单明了，望文知义</h3><p>标识符采用英文单词。切忌使用汉语拼音来命名。程序中的英文单词一般不要太复杂，用词应当准确。例如不要把CurrentValue写成NowValue。</p><p>尽量不要使用单词缩写或首字母缩写。只有当标识符过长时才考虑使用单词缩写。在使用缩写时，不要自创缩写，尽量使用被广泛接受的缩写。</p><h3 id="规则2-标识符长度应当符合“min-length-max-information”原则"><a href="#规则2-标识符长度应当符合“min-length-max-information”原则" class="headerlink" title="规则2 标识符长度应当符合“min-length &amp;&amp; max-information”原则"></a>规则2 标识符长度应当符合“min-length &amp;&amp; max-information”原则</h3><p>一般的讲，长名字能更好地表达含义，所以函数名、变量名、类名长达十几个字符不足为怪。但是名字也不是越长越好。例如：变量名maxval就比maxValueUntilOverflow更好用。单字符的名字也是有用的，常见的如i,j,k,m,n,x,y,z等，它们通常用作函数内的局部变量。</p><h3 id="规则3-命名规则尽量与所采用的操作系统或开发工具的风格保持一致"><a href="#规则3-命名规则尽量与所采用的操作系统或开发工具的风格保持一致" class="headerlink" title="规则3 命名规则尽量与所采用的操作系统或开发工具的风格保持一致"></a>规则3 命名规则尽量与所采用的操作系统或开发工具的风格保持一致</h3><p>例如，Windows应用程序的标识符通常采用“大小写”混排的方式，如AddChild。而Unix应用程序的标识符通常采用“小写加下划线”的方式，如add_child。别把这两类风格混在一起用。</p><h3 id="规则4-程序中不要出现仅靠大小写区分的标识符"><a href="#规则4-程序中不要出现仅靠大小写区分的标识符" class="headerlink" title="规则4 程序中不要出现仅靠大小写区分的标识符"></a>规则4 程序中不要出现仅靠大小写区分的标识符</h3><p>例如：int x和int X；void foo() 和void FOO() 等。</p><h3 id="规则5-避免在不同级别的作用域中重名"><a href="#规则5-避免在不同级别的作用域中重名" class="headerlink" title="规则5 避免在不同级别的作用域中重名"></a>规则5 避免在不同级别的作用域中重名</h3><p>程序中不要出现标识符完全相同的局部变量和全局变量，尽管两者因作用域的不同而不会发生语法错误，但会使人产生误解。</p><h3 id="规则6-正确命名具有互斥意义的标识符"><a href="#规则6-正确命名具有互斥意义的标识符" class="headerlink" title="规则6 正确命名具有互斥意义的标识符"></a>规则6 正确命名具有互斥意义的标识符</h3><p>使用正确的反义词组命名具有互斥意义的变量或相反动作的函数。</p><p>如：”MinValue”和”MaxValue”，”GetName()” 和 “SetName()”</p><h3 id="规则7-尽量避免名字中出现数字编号"><a href="#规则7-尽量避免名字中出现数字编号" class="headerlink" title="规则7 尽量避免名字中出现数字编号"></a>规则7 尽量避免名字中出现数字编号</h3><p>如Value1,Value2等，除非逻辑上的确需要编号。这是为了防止程序产生无意义的名字，降低程序的可读性。</p><h3 id="规则8-使用库标志"><a href="#规则8-使用库标志" class="headerlink" title="规则8 使用库标志"></a>规则8 使用库标志</h3><p>在开发动态库时，为了防止软件库中的一些标识符和其它软件库中标识符冲突，可以为各种标识符加上能反映软件性质的前缀。</p><p>例如三维图形标准OpenGL的所有库函数均以gl开头，所有常量（或宏定义）均以GL开头。</p><h2 id="细则"><a href="#细则" class="headerlink" title="细则"></a>细则</h2><p>采用了一部分的“匈牙利”法命名规范，但没有照搬。“匈牙利”法最大的特征就是类型前缀。例如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> nNum = <span class="number">0</span>; <span class="comment">// n 为类型信息，表明 nNum 是一个 int 类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CUser</span>; <span class="comment">// C 为类型信息，表明 CUser 是一个类</span></span><br></pre></td></tr></table></figure><p>但在单字符的变量中，如i，j，k中继续使用匈牙利命名法就会给人一种繁琐的感觉。因此，添加变量的类型前缀是一个可选的命名规则。</p><h3 id="类和接口"><a href="#类和接口" class="headerlink" title="类和接口"></a>类和接口</h3><blockquote><p>除了异常类等个别情况（不希望用户把该类看作一个普通的、正常的类之情况）外，C++类&#x2F;结构的命名应该遵循以下准则：　C++类&#x2F;结构的命名类的名称都要以大写字母“C”开头，后跟一个或多个单词。为便于界定，每个单词的首字母要大写。</p><p>推荐的组成形式类的命名推荐用”名词”或”形容词＋名词”的形式，例如：”CAnalyzer”, “CFastVector” …. 不同于C++类的概念，传统的C结构体只是一种将一组数据捆绑在一起的方式。传统C结构体的命名规则为：C结构体的名称全部由大写字母组成，单词间使用下划线界定，例如：”SERVICE_STATUS”, “DRIVER_INFO”</p></blockquote><ol><li><strong>命名：</strong>类名都以大写字母“C”开头，后跟一个或多个单词。每个单词的首字母要大写。接口以大写”I”开头，代表Interface。</li><li><strong>组成形式：</strong>推荐用”名词”或”形容词＋名词”的形式，例如：”CAnalyzer”, “CFastVector”</li></ol><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ol><li><strong>命名：</strong>函数的名称由一个或多个单词组成。每个单词的首字母要大写。最长不得超过20个字符。</li><li><strong>组成形式：</strong>全局函数应当使用”动词”或者”动词＋名词”（动宾词组）的形式。例如：”gGetName()”, “ gDrawBox()”。</li></ol><table><thead><tr><th align="center">特殊函数类型</th><th align="center">命名规则</th></tr></thead><tbody><tr><td align="center">保护成员函数</td><td align="center">保护成员函数的开头应当加上一个下划线“_”以示区别，例如：”_SetState()”</td></tr><tr><td align="center">私有成员函数</td><td align="center">类似地，私有成员函数的开头应当加上两个下划线“__”，例如：”__DestroyImp()”</td></tr><tr><td align="center">虚函数</td><td align="center">虚函数习惯以“Do”开头，如：”DoRefresh()”, “_DoEncryption()”</td></tr><tr><td align="center">回调和事件处理函数</td><td align="center">回调和事件处理函数习惯以单词“On”开头。例如：”_OnTimer()”, “OnExit()”</td></tr></tbody></table><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>变量是程序中使用最多的标识符，变量的命名规范是一套C++命名规范中最重要的部分：</p><ol><li><p><strong>命名：</strong>变量名由作用域前缀＋类型前缀＋一个或多个单词组成。变量用小写字母开头的单词组合而成，第二个单词的首字母要大写。例如：int nDrawMode。变量最长不得超过20个字符。特殊的：对于某些用途简单明了的局部变量，也可以使用简化的方式，如：i, j, k, x, y, z</p></li><li><p><strong>组成形式：</strong>变量的名字应当使用”名词”或者”形容词＋名词”。例如：”nCode”, “m_nState”，”nMaxWidth”，” oldValue “，” newValue “。</p></li><li><p><strong>作用域前缀：</strong>作用域前缀标明一个变量的可见范围。作用域可以有如下几种：</p></li></ol><table><thead><tr><th align="left">前缀</th><th>说明</th><th align="left">例子</th></tr></thead><tbody><tr><td align="left">无</td><td>局部变量</td><td align="left"></td></tr><tr><td align="left">m_</td><td>类的成员变量（member）</td><td align="left">int m_width;</td></tr><tr><td align="left">ms_</td><td>类的静态成员变量（static member）</td><td align="left">static int ms_initValue;</td></tr><tr><td align="left">s_</td><td>静态变量（static）</td><td align="left">static int s_initValue;</td></tr><tr><td align="left">g_</td><td>外部全局变量（global）</td><td align="left">int g_howManyPeople;</td></tr><tr><td align="left">sg_</td><td>静态全局变量（static global）</td><td align="left"></td></tr><tr><td align="left">gg_</td><td>进程间共享的共享数据段全局变量（global global）</td><td align="left"></td></tr></tbody></table><p>说明：作用域前缀不同于下面的类型前缀，应该坚决执行。原因是：</p><ul><li><p>变量作用域和链接性改变的情况是很少的，例如，很少的情况下会把一个成员变量改成静态变量</p></li><li><p>编程中使用的工具常常不会直观的显示变量的作用域和链接性</p></li></ul><ol start="4"><li>类型前缀</li></ol><table><thead><tr><th>前缀</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td>b</td><td>布尔型变量（bool, BOOL）</td><td>bEnable</td></tr><tr><td>ch</td><td>字符型变量（char TCHAR）</td><td>chName</td></tr><tr><td>lpsz</td><td>LPSTR、LPCSTR、LPCTSTR</td><td>lpszName</td></tr><tr><td>n</td><td>整型和位域变量（int, UINT,__int32,__int64）</td><td>nLength</td></tr><tr><td>l</td><td>long</td><td>lOffset</td></tr><tr><td>by</td><td>BYTE</td><td></td></tr><tr><td>w</td><td>WORD</td><td>wPos</td></tr><tr><td>dw</td><td>DWORD</td><td>dwRange</td></tr><tr><td>f</td><td>浮点型变量（float）</td><td></td></tr><tr><td>d</td><td>double</td><td></td></tr><tr><td>p</td><td>指针型变量和迭代子（pointer）</td><td>pDoc</td></tr><tr><td>lp</td><td>远指针</td><td></td></tr><tr><td>e</td><td>枚举型变量（enumeration）</td><td></td></tr><tr><td>pfn</td><td>特别针对指向函数的指针变量和函数对象指针（pointer of function）</td><td></td></tr><tr><td>g</td><td>数组（grid）</td><td></td></tr><tr><td>h</td><td>handle Windows对象句柄</td><td>hWnd</td></tr></tbody></table><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>常量名由类型前缀＋全大写字母组成，单词间通过下划线来界定，如：cDELIMITER, nMAX_BUFFER。类型前缀的定义与变量命名规则中的相同。</p><h3 id="结构体、宏、枚举变量、联合体"><a href="#结构体、宏、枚举变量、联合体" class="headerlink" title="结构体、宏、枚举变量、联合体"></a>结构体、宏、枚举变量、联合体</h3><p>全部由前缀+大写字母组成，单词间使用下划线界定。</p><ol><li><strong>结构体：</strong>加小写前缀”tag”，之后以大写字母开头。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagPOINT</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> x;</span><br><span class="line"><span class="type">int</span> y;</span><br><span class="line">&#125; POINT;</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>宏：</strong>大写字母组成，单词间使用下划线界定。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAXNUMBER 100</span></span><br></pre></td></tr></table></figure><ol start="3"><li><strong>枚举变量：</strong>加小写前缀”enum”。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_FILE_OPEN_MODE</span></span><br><span class="line">&#123;</span><br><span class="line">OPEN_READONLY，</span><br><span class="line">OPEN_READWRITE</span><br><span class="line">&#125;FILE_OPEN_MODE;</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>联合体：</strong>加小写前缀”uni”。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">_VARIANT</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> unichVal;</span><br><span class="line"><span class="type">int</span> uninVal;</span><br><span class="line"><span class="type">float</span> uniftVal;</span><br><span class="line">&#125; VARIANT;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UPBGE虚拟仿真自动驾驶</title>
      <link href="/2023/09/07/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/"/>
      <url>/2023/09/07/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/</url>
      
        <content type="html"><![CDATA[<center>    该项目以UPBGE为基础，在UPBGE中构建出一座虚拟仿真城市，通过该虚拟试验场来进行自动驾驶训练，以达到脱离现实场景对车辆自动驾驶进行训练的目的。这也是我们在虚拟环境中进行实验的一次初步探索，为我们了解Blender建模方法，UPBGE基本控件及组件开发，车辆与AI算法数据流通以及初级自动驾驶强化学习算法提供了条件。通过对该项目的逻辑分析，我认为虚拟仿真实验的进行应分为以下三个部分：虚拟试验场建模，实体控制组件，人工智能算法。下面从这三个方面出发进行简单介绍。</center><blockquote><p>参考资料：<a href="https://github.com/FengQuanLi/qhx">https://github.com/FengQuanLi/qhx</a></p></blockquote><span id="more"></span><h2 id="虚拟实验场建模"><a href="#虚拟实验场建模" class="headerlink" title="虚拟实验场建模"></a>虚拟实验场建模</h2><h3 id="Blender版本"><a href="#Blender版本" class="headerlink" title="Blender版本"></a>Blender版本</h3><p>该项目中对Blender版本有着极为严苛的控制，UPBGE-0.2.5版本会导致vsCode对Blender无法进行调试，其版本过低，UPBGE-0.3.0稳定版及更新的版本会导致该项目引用的载具控制模块无法使用，因为高版本下UPBGE存在功能缺失的问题。</p><blockquote><p>推荐Windows版本：<a href="https://pan.baidu.com/s/1YkGwpAjY7pvMa0FWtVAGiA">UPBGE-EEVEE-Win64-2021-02-02</a>     密码：7bga</p><p>推荐Linux版本：<a href="https://pan.baidu.com/s/1ioewOha9kzMwhFU_U0r83w">UPBGE-EEVEE-Linux64-2021-02-02</a>     密码：olhf</p><p>参考官网：<a href="https://mega.nz/folder/k9MW1KiZ#UOKzjh3IQ0GEgjQ6GUc7ug/folder/YsshHCha">https://mega.nz/folder/k9MW1KiZ#UOKzjh3IQ0GEgjQ6GUc7ug/folder/YsshHCha</a></p></blockquote><h3 id="城市模型来源"><a href="#城市模型来源" class="headerlink" title="城市模型来源"></a>城市模型来源</h3><p>由于建模的工程量巨大，可以直接使用社区中已经发布的现有模型进行实验。</p><blockquote><p>模型来源：<a href="https://www.cgtrader.com/free-3d-models/architectural/street/realistic-city-52b92dfa-197d-4d9e-97a8-955cad13b603">Realistic City free VR &#x2F; AR &#x2F; low-poly 3d model</a></p></blockquote><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220709131416043-467417406-169407701441358.jpg" alt="Realistic City "></p><h3 id="汽车模型来源"><a href="#汽车模型来源" class="headerlink" title="汽车模型来源"></a>汽车模型来源</h3><p>为使汽车模型更加贴近现实，同样使用社区中发布的汽车模型进行实验。</p><blockquote><p>模型来源：<a href="https://blendswap.com/blend/25287">60’s Car</a></p></blockquote><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220709132040534-256841214-169407701441460.png" alt="image-20220709132028434"></p><h2 id="实体控制组件"><a href="#实体控制组件" class="headerlink" title="实体控制组件"></a>实体控制组件</h2><h3 id="汽车动力学组件来源"><a href="#汽车动力学组件来源" class="headerlink" title="汽车动力学组件来源"></a>汽车动力学组件来源</h3><p>由于涉及到汽车的具体控制，包括汽车档位控制，方向盘控制，物理属性的设置等，要将其完全实现并且贴近现实工作量大，所以该项目引入了另一个开源的汽车控制模块，来实现汽车控制。</p><blockquote><p>参考资料：<a href="https://github.com/BiancaMel/CustomVehiclePhysics-UPBGE">https://github.com/BiancaMel/CustomVehiclePhysics-UPBGE</a></p></blockquote><h4 id="源程序目录"><a href="#源程序目录" class="headerlink" title="源程序目录"></a>源程序目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">VehiclePhysicsExample1</span><br><span class="line">│   ActiveCameraRender.py</span><br><span class="line">│   MathLib.py<span class="comment">#数学计算相关库</span></span><br><span class="line">│   MyPlayerController.py<span class="comment">#汽车移动控制组件</span></span><br><span class="line">│   MyVehicleComponent.py<span class="comment">#汽车初始化组件</span></span><br><span class="line">│   VehiclePhysics.py<span class="comment">#汽车物理属性及类的定义</span></span><br><span class="line">│   VehiclePhysicsExample1.blend<span class="comment">#UPBGE项目</span></span><br><span class="line">│   VehiclePhysicsExample1.blend1<span class="comment">#临时文件</span></span><br><span class="line">│   VehicleWheel.py<span class="comment">#汽车轮胎控制</span></span><br><span class="line">│   WheelBack.json</span><br><span class="line">│   WheelFront.json</span><br><span class="line">│</span><br><span class="line">├───.vscode</span><br><span class="line">│       settings.json</span><br><span class="line">│</span><br><span class="line">├───bgelogic</span><br><span class="line">│   │   NLmycar.py</span><br><span class="line">│   │   __init__.py</span><br><span class="line">│   │</span><br><span class="line">│   └───__pycache__</span><br><span class="line">│           NLmycar.cpython-39.pyc</span><br><span class="line">│           __init__.cpython-39.pyc</span><br><span class="line">│</span><br><span class="line">└───__pycache__<span class="comment">#python字节码缓存文件</span></span><br><span class="line">        ActiveCameraRender.cpython-310.pyc</span><br><span class="line">        ActiveCameraRender.cpython-39.pyc</span><br><span class="line">        MathLib.cpython-310.pyc</span><br><span class="line">        MathLib.cpython-39.pyc</span><br><span class="line">        module.cpython-39.pyc</span><br><span class="line">        MyPlayerController.cpython-39.pyc</span><br><span class="line">        MyVehicleComponent.cpython-310.pyc</span><br><span class="line">        MyVehicleComponent.cpython-39.pyc</span><br><span class="line">        pythonTest.cpython-310.pyc</span><br><span class="line">        pythonTest.cpython-39.pyc</span><br><span class="line">        VehiclePhysics.cpython-310.pyc</span><br><span class="line">        VehiclePhysics.cpython-39.pyc</span><br><span class="line">        VehicleWheel.cpython-310.pyc</span><br><span class="line">        VehicleWheel.cpython-39.pyc</span><br></pre></td></tr></table></figure><h4 id="加载组件"><a href="#加载组件" class="headerlink" title="加载组件"></a>加载组件</h4><p>使用UPBGE启动<code>VehiclePhysicsExample1.blend</code>，或者使用vsCode组件<strong>Blender Development</strong>直接debug启动该项目。</p><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220710130009148-1876210470.png" alt="image-20220709193419445"></p><p>选择场景中的物体<strong>Vehicle</strong>，在<code>VehiclePhysics.py</code>中通过搜索该物体的子集来寻找轮子进行控制。</p><p>使用Blender的<strong>Logic Bricks Editor</strong>来对组件进行编辑，如图中的<strong>Components</strong>窗口，点击<strong>Register Component</strong>进行操作，先添加<strong>MyVehicleComponent</strong>组件，再添加<strong>MyPlayController</strong>组件，注意顺序不要弄错，其顺序与内部程序设置有关。</p><blockquote><p>组件的添加规则为必须输入 python 脚本的名称（不带 .py），后跟一个点和类名，见<a href="https://upbge.org/#/documentation/docs/latest/manual/manual/python_components/introduction.html">官方文档python Component</a>介绍。</p></blockquote><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220710125955302-666391647.png" alt="../../_images/Fig-06.png"></p><h4 id="可能出现的问题"><a href="#可能出现的问题" class="headerlink" title="可能出现的问题"></a>可能出现的问题</h4><ul><li>“ModuleNotFoundError: No module named ‘bge’”</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RuntimeError: Error: Python: Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;c:\Users\ASUS\.vscode\extensions\jacqueslucke.blender-development-0.0.17\pythonFiles\include\blender_vscode\operators\script_runner.py&quot;</span>, line 16, <span class="keyword">in</span> execute</span><br><span class="line">    runpy.run_path(self.filepath, init_globals=&#123;<span class="string">&quot;CTX&quot;</span> : ctx&#125;)</span><br><span class="line">  File <span class="string">&quot;d:\UPBGE\UPBGE-EEVEE-Win64-2021-03-30\Release\2.93\python\lib\runpy.py&quot;</span>, line 268, <span class="keyword">in</span> run_path</span><br><span class="line">    <span class="built_in">return</span> _run_module_code(code, init_globals, run_name,</span><br><span class="line">  File <span class="string">&quot;d:\UPBGE\UPBGE-EEVEE-Win64-2021-03-30\Release\2.93\python\lib\runpy.py&quot;</span>, line 97, <span class="keyword">in</span> _run_module_code</span><br><span class="line">    _run_code(code, mod_globals, init_globals,</span><br><span class="line">  File <span class="string">&quot;d:\UPBGE\UPBGE-EEVEE-Win64-2021-03-30\Release\2.93\python\lib\runpy.py&quot;</span>, line 87, <span class="keyword">in</span> _run_code</span><br><span class="line">    <span class="built_in">exec</span>(code, run_globals)</span><br><span class="line">  File <span class="string">&quot;d:\UPBGE\CustomVehiclePhysics-UPBGE-master\VehiclePhysicsExample1.bak\VehiclePhysics.py&quot;</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import bge</span><br><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;bge&#x27;</span></span><br></pre></td></tr></table></figure><p>原因在于直接启动脚本时bge库不会加载，bge库只有在游戏引擎启动时加载。</p><ul><li>“No module named “MyVehicleComponent” or script error at loading.”</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;D:\UPBGE\CustomVehiclePhysics-UPBGE-master\VehiclePhysicsExample1.bak\VehiclePhysicsExample1.blend\MyVehicleComponent.py&quot;</span>, line 7, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    </span><br><span class="line">AttributeError: module <span class="string">&#x27;bge&#x27;</span> has no attribute <span class="string">&#x27;logic&#x27;</span></span><br></pre></td></tr></table></figure><p>其在register component或reload component组件时出现上述问题，原因在于Blender在添加组件检索import文件时，其只会在内部库文件中寻找，若导入外部库，则会出现因为找不到该库文件从而导致组件加载失败。</p><p>解决办法为先将导入外部库文件的那一行注释掉，加载组件完成后再将其取消注释。</p><p>若上述办法无法解决，请检查组件程序是否存在语法错误。</p><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220710130001493-769009049.png" alt="image-20220709200503892"></p><ul><li>“TypeError: Element-wise multiplication: not supported between ‘Vector’ and ‘Matrix’ types”</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;D:\UPBGE\CustomVehiclePhysics-UPBGE-master\VehiclePhysicsExample1.bak\VehiclePhysics.py&quot;</span>, line 308, <span class="keyword">in</span> PreUpdate</span><br><span class="line">    WheelObject.Wheel.LocalPosition = (EndRayPoint - self.worldPosition) * self.worldOrientation + Vector([0, 0, WheelObject.Wheel.Radius])</span><br><span class="line">TypeError: Element-wise multiplication: not supported between <span class="string">&#x27;Vector&#x27;</span> and <span class="string">&#x27;Matrix&#x27;</span> types</span><br></pre></td></tr></table></figure><p>原因在于该方法适用于 Blender &lt;&#x3D;2.79.9。 Blender 已经调整了它的 <strong>mathutils</strong> 模块，将星号 * 替换为 at 符号 @，也就是 <a href="https://peps.python.org/pep-0465/">PEP 465</a> 二元运算符，用于将矩阵与向量相乘。</p><ul><li>“使用摄像机视角启动游戏时闪退”</li></ul><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220710132408404-870600400.png" alt="image-20220710132401708"></p><p>原因可能在于摄像机跟随<strong>Collider</strong>，而游戏启动时<strong>Collider</strong>试图未显示，导致摄像机未找到而闪退。解决方法为打开<strong>Visibility</strong>，勾选<strong>Viewports</strong>即可。</p><h3 id="游戏项目组件"><a href="#游戏项目组件" class="headerlink" title="游戏项目组件"></a>游戏项目组件</h3><h4 id="源程序目录-1"><a href="#源程序目录-1" class="headerlink" title="源程序目录"></a>源程序目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cargame</span><br><span class="line">│   CamController.py<span class="comment">#全局视角脚本</span></span><br><span class="line">│   guodu.py<span class="comment">#与VehicleWheels.py内容一样</span></span><br><span class="line">│   jilu copy.py</span><br><span class="line">│   jilu.py<span class="comment">#碰撞检测，启动tcp/ip</span></span><br><span class="line">│   MathLib.py<span class="comment">#数学计算</span></span><br><span class="line">│   MyVehicle.py<span class="comment">#车辆初始化</span></span><br><span class="line">│   PlayerController.py<span class="comment">#控制车辆移动</span></span><br><span class="line">│   python_component.py<span class="comment">#测试使用</span></span><br><span class="line">│   VehiclePhysicsExampleeeveed181.blend<span class="comment">#upbge项目文件</span></span><br><span class="line">│   VehiclePhysicsExampleeeveed181.blend1<span class="comment">#缓存</span></span><br><span class="line">│   VehicleWheel.py<span class="comment">#车轮控制</span></span><br><span class="line">│   WheelBack.json</span><br><span class="line">│   WheelFront.json</span><br><span class="line">│   载具物理性质.py<span class="comment">#汽车物理属性及类的定义</span></span><br><span class="line">│</span><br><span class="line">├───.vscode<span class="comment">#vscode设置</span></span><br><span class="line">│       settings.json</span><br><span class="line">│</span><br><span class="line">├───bgelogic</span><br><span class="line">└───__pycache__<span class="comment">#python字节码缓存文件</span></span><br><span class="line">        CamController.cpython-39.pyc</span><br><span class="line">        jilu.cpython-37.pyc</span><br><span class="line">        jilu.cpython-39.pyc</span><br><span class="line">        MathLib.cpython-37.pyc</span><br><span class="line">        MathLib.cpython-39.pyc</span><br><span class="line">        MyVehicle.cpython-37.pyc</span><br><span class="line">        MyVehicle.cpython-39.pyc</span><br><span class="line">        PlayerController.cpython-37.pyc</span><br><span class="line">        PlayerController.cpython-39.pyc</span><br><span class="line">        PlayerController1.cpython-39.pyc</span><br><span class="line">        python_component.cpython-39.pyc</span><br><span class="line">        VehicleWheel.cpython-37.pyc</span><br><span class="line">        VehicleWheel.cpython-39.pyc</span><br><span class="line">        载具物理性质.cpython-37.pyc</span><br><span class="line">        载具物理性质.cpython-39.pyc</span><br></pre></td></tr></table></figure><h4 id="加载组件-1"><a href="#加载组件-1" class="headerlink" title="加载组件"></a>加载组件</h4><ul><li>MyVehicle</li></ul><p>该组件与<code>载具物理性质.py</code>和<code>VehicleWheel.py</code>及其下属的<code>json</code>文件一起，起到初始化车辆的功能。</p><ul><li>PlayerController</li></ul><p>该组件起到控制车辆移动的功能。</p><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220711101937623-1946081321.png" alt="image-20220711101931377"></p><p>如图，上述两组件应一块注册到场景中的<strong>VehicleTest</strong>上，且先注册<strong>MyVehicle</strong>再注册<strong>PlayerController</strong>，顺序不能混淆。</p><ul><li>pengzhuang</li></ul><p>该组件起到检测碰撞并上传的功能，在碰撞发生后，启动tcp&#x2F;ip线程，将信息传递给AI控制部分。</p><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220711103350133-1518508217.png" alt="image-20220711103346940"></p><p>如图，上述组件应注册到场景中的<strong>碰撞集合</strong>上，该组件在<code>jilu.py</code>中得到定义。</p><ul><li>CamController</li></ul><p>该脚本起到增加一个全局视角的功能。</p><p><img src="/images/UPBGE%E8%99%9A%E6%8B%9F%E4%BB%BF%E7%9C%9F%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/2169984-20220711104823541-286893413.png" alt="image-20220711104820445"></p><p>如图，<code>CamController.py</code>使用<strong>Logic Bricks Editor</strong>绑定任意一场景中的物体上，如<strong>VehicleTest</strong>。</p><h2 id="人工智能算法"><a href="#人工智能算法" class="headerlink" title="人工智能算法"></a>人工智能算法</h2><ul><li>“RuntimeError: Can’t call numpy() on Tensor that requires grad. Use tensor.detach().numpy() instead.”</li></ul>]]></content>
      
      
      <categories>
          
          <category> UPBGE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> upbge </tag>
            
            <tag> auto drive </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode-blender调试环境</title>
      <link href="/2023/09/07/vscode-blender%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"/>
      <url>/2023/09/07/vscode-blender%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<center>UPBGE 是一个开源的 3D 游戏引擎，它源自旧的 Blender 游戏引擎，并与 Blender 本身一起部署。这种统一的工作流程是它的主要优势，因为您可以在不离开 Blender 的情况下从头到尾制作游戏。</center><hr><blockquote><p>事实上，UPBGE在代码调试方面极为不便，其自带的文件编辑器与成熟的IDE相比缺失太多功能，如代码自动补全，断点调试等。因此，我们主要探究其在Vs Code环境下与Blender程序建立连接，从而能够方便代码调试的方法，本篇文章不涉及Vs Code与Blender的基础应用，如有需要，请自行了解。</p><p>参考资料：<a href="https://zhuanlan.zhihu.com/p/91278311">https://zhuanlan.zhihu.com/p/91278311</a></p></blockquote><h2 id="VsCode-IDE安装"><a href="#VsCode-IDE安装" class="headerlink" title="VsCode IDE安装"></a>VsCode IDE安装</h2><p>参考<a href="https://code.visualstudio.com/">Vs Code官网</a></p><h2 id="Python安装"><a href="#Python安装" class="headerlink" title="Python安装"></a>Python安装</h2><p>参考<a href="https://www.python.org/">Python官网</a></p><blockquote><p>这里需要注意的是尽量安装<strong>python3.7</strong>及以上版本</p></blockquote><h2 id="UPBGE安装"><a href="#UPBGE安装" class="headerlink" title="UPBGE安装"></a>UPBGE安装</h2><p>参考<a href="https://upbge.org/#/">UPBGE官网</a></p><h2 id="VsCode对Blender库的自动补全"><a href="#VsCode对Blender库的自动补全" class="headerlink" title="VsCode对Blender库的自动补全"></a>VsCode对Blender库的自动补全</h2><p>由于UPBGE使用的bge库只能在游戏引擎加载时才自动导入，在外部IDE甚至于UPBGE内部自带的脚本编辑器都无法运行，因此我们使用<strong>fake-bpy-module</strong>和<strong>fake-bge-module</strong>这两个库来进行代码编辑，但实际上脚本无法运行，仍需通过启动游戏引擎的方式来进行调试与运行(两个库都是<strong>fake</strong>)。</p><h3 id="安装fake-bpy-module"><a href="#安装fake-bpy-module" class="headerlink" title="安装fake-bpy-module"></a>安装fake-bpy-module</h3><blockquote><p>参考资料：<a href="https://github.com/nutti/fake-bpy-module">https://github.com/nutti/fake-bpy-module</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install fake-bpy-module-latest</span><br></pre></td></tr></table></figure><h3 id="安装fake-bge-module"><a href="#安装fake-bge-module" class="headerlink" title="安装fake-bge-module"></a>安装fake-bge-module</h3><blockquote><p>参考资料：<a href="https://pypi.org/project/fake-bge-module-0.2.5/">https://pypi.org/project/fake-bge-module-0.2.5/</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install fake-bge-module-0.2.5</span><br></pre></td></tr></table></figure><h3 id="安装Kite进行代码补全"><a href="#安装Kite进行代码补全" class="headerlink" title="安装Kite进行代码补全"></a>安装Kite进行代码补全</h3><blockquote><p>这里未选择使用pylint或者其他工具进行自动补全，我自己偏向于使用kite，若想使用其他工具，请自行了解</p></blockquote><ul><li><p>下载<strong>Kite</strong>，参考<a href="https://www.kite.com/integrations/vs-code/">Kite官网</a></p></li><li><p>VsCode插件<strong>Kite AutoComplete AI Code</strong>安装：</p><p><img src="/images/vscode-blender%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/2169984-20220708122139426-404073668.png" alt="image-20220706163252570"></p><p>连接成功后VsCode状态栏出现Ready等连接成功的提示，同时自动补全功能出现，并伴随有<strong>Kite</strong>标识</p><p><img src="/images/vscode-blender%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/2169984-20220708122127617-214577209.png" alt="image-20220706164329315"></p></li></ul><h2 id="VsCode-Extensions安装"><a href="#VsCode-Extensions安装" class="headerlink" title="VsCode Extensions安装"></a>VsCode Extensions安装</h2><h3 id="VsCode插件Blender-Development安装"><a href="#VsCode插件Blender-Development安装" class="headerlink" title="VsCode插件Blender Development安装"></a>VsCode插件<strong>Blender Development</strong>安装</h3><blockquote><p>参考资料：<a href="https://github.com/JacquesLucke/blender_vscode">https://github.com/JacquesLucke/blender_vscode</a></p></blockquote><p><img src="/images/vscode-blender%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/2169984-20220708122145331-1679406814.png" alt="image-20220706155023964"></p><h3 id="新建addon"><a href="#新建addon" class="headerlink" title="新建addon"></a>新建addon</h3><p><code>ctrl+shift+P</code>或者<code>F1</code>调出命令台，输入blender即可显示该插件所有功能，选择<strong>simple</strong>，首先输入addon名称，再输入addon作者名称，输入完成后将其保存在一个空文件夹中。</p><h3 id="启动UPBGE"><a href="#启动UPBGE" class="headerlink" title="启动UPBGE"></a>启动UPBGE</h3><p><code>ctrl+shift+P</code>或者<code>F1</code>调出命令台，选择blender start，输入UPBGE的执行文件路径，第一次启动时会自动下载<strong>debugpy</strong>和进行一些配置，稍作等待即可启动成功</p><blockquote><p>在下载第一次启动blender start时，务必关闭所有的网络代理软件，或者取消系统代理，否则pip会认为不安全而拒绝访问</p></blockquote><p><img src="/images/vscode-blender%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/2169984-20220708122150199-538663948.png" alt="image-20220706165725467"></p><p>启动成功后会出现提示</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> * Serving Flask app &#x27;Blender Server&#x27; (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: on</span><br><span class="line"> * Running on http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9953</span> (Press CTRL+C to quit)</span><br><span class="line">Sending: &#123;&#x27;type&#x27;: <span class="string">&#x27;setup&#x27;</span>, <span class="string">&#x27;blenderPort&#x27;</span>: <span class="number">9953</span>, <span class="string">&#x27;debugpyPort&#x27;</span>: <span class="number">5939</span>, <span class="string">&#x27;blenderPath&#x27;</span>: <span class="string">&#x27;d:\\UPBGE\\UPBGE-0.30-windows-x86_64\\blender.exe&#x27;</span>, <span class="string">&#x27;scriptsFolder&#x27;</span>: <span class="string">&#x27;d:\\UPBGE\\UPBGE-0.30-windows-x86_64\\3.0\\scripts&#x27;</span>, <span class="string">&#x27;addonPathMappings&#x27;</span>: []&#125;</span><br><span class="line">Waiting for debug client.</span><br><span class="line">Debug client attached.</span><br></pre></td></tr></table></figure><p>调试时在UPBGE中启动游戏引擎，不可直接使用blender: Run Script</p>]]></content>
      
      
      <categories>
          
          <category> Blender </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blender </tag>
            
            <tag> vscode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实验室内网远程访问</title>
      <link href="/2023/09/07/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/"/>
      <url>/2023/09/07/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<center>    此次实验室内部组网与外部访问共提供两种方案：第一种为方案使用蒲公英旁路由在不改变原来网络拓扑结构的情况下进行组网，使用蒲公英公司服务器进行VPN转发；第二种方案为使用师大VPN直接对映射到校园网IP的端口进行访问，其使用EasyConnect连接，深信服公司服务器进行VPN转发</center><span id="more"></span><h2 id="蒲公英盒子"><a href="#蒲公英盒子" class="headerlink" title="蒲公英盒子"></a>蒲公英盒子</h2><h3 id="登录管理地址"><a href="#登录管理地址" class="headerlink" title="登录管理地址"></a>登录管理地址</h3><blockquote><p>SN: 347340079067</p><p>default password: admin</p><p>current password: xnfzsys@123456</p></blockquote><p>登录管理地址：<a href="">pgybox.oray.com</a></p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731173836195-530688389-169407690423926.png" alt="image-20220731173333373"></p><h3 id="组网"><a href="#组网" class="headerlink" title="组网"></a>组网</h3><p>添加旁路由盒子为硬件成员。</p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731175009441-1876591225-169407690423928.png" alt="image-20220731174950430"></p><h3 id="访问端"><a href="#访问端" class="headerlink" title="访问端"></a>访问端</h3><p>购买硬件后自动将体验版升级为标准版，其配置如下：</p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731175335224-1112302629-169407690423930.png" alt="image-20220731175316924"></p><p>标准版总成员数为3个，其中硬件占一个，剩余可使用的访问端数量为2个，其登录信息如下：</p><blockquote><p>访问端账号1：</p><p>UID：56491601:001</p><p>password：123456</p></blockquote><blockquote><p>访问端账号2：</p><p>UID：56491601:002</p><p>password：123456</p></blockquote><h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><h4 id="下载蒲公英个人版访问端"><a href="#下载蒲公英个人版访问端" class="headerlink" title="下载蒲公英个人版访问端"></a>下载蒲公英个人版访问端</h4><blockquote><p>官网地址：<a href="https://pgy.oray.com/download/personal/#visitor">https://pgy.oray.com/download/personal/#visitor</a></p></blockquote><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731180007686-1035548873-169407690423932.png" alt="image-20220731175946146"></p><h4 id="使用访问端账号登录"><a href="#使用访问端账号登录" class="headerlink" title="使用访问端账号登录"></a>使用访问端账号登录</h4><p><strong>这里需要注意的是尽量不要勾选自动登录，同时取消该软件的开机自启动，因为访问端账号有限，防止在不必要时抢占网络资源！！</strong></p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/image-20220731180102575-169407690424246.png" alt="image-20220731180102575"></p><h4 id="登入界面"><a href="#登入界面" class="headerlink" title="登入界面"></a>登入界面</h4><p><strong>这里需要注意的是本地局域网IP不能与实验室的网断冲突，否则VPN无法判断你需要连接的内网地址。</strong></p><blockquote><p>实验室网段：192.168.3.-</p></blockquote><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731180243504-339024066-169407690423934.png" alt="image-20220731180225297"></p><h4 id="如何判断登录成功"><a href="#如何判断登录成功" class="headerlink" title="如何判断登录成功"></a>如何判断登录成功</h4><p>原则上来说，登陆成功后可以访问所有实验室局域网中设备其本身的地址，此时并不需要任何映射或者虚拟IP，仿佛当前设备接入实验室内网中。</p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731180712246-296219854-169407690423936.png" alt="image-20220731180650829"></p><h2 id="校园网VPN"><a href="#校园网VPN" class="headerlink" title="校园网VPN"></a>校园网VPN</h2><p>因为实验室网络相当于校园网的内网，所以相对于上述使用蒲公英的方法，此种方法设置会稍微麻烦一些，要手动将需要的端口映射上去。其原理为实验室局域网服务器使用NAT的方式，将服务端口映射到路由器的广域网（也就是校园网）对应的IP上。</p><h3 id="登录路由器"><a href="#登录路由器" class="headerlink" title="登录路由器"></a>登录路由器</h3><blockquote><p>路由器登录信息：</p><p>IP：192.168.3.1</p><p>Password：xnfzsys@123456</p></blockquote><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731181322736-2045334609-169407690423938.png" alt="image-20220731181303519"></p><h3 id="选择NAT服务"><a href="#选择NAT服务" class="headerlink" title="选择NAT服务"></a>选择NAT服务</h3><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731181623000-1167336994-169407690423940.png" alt="image-20220731181604611"></p><h3 id="映射端口"><a href="#映射端口" class="headerlink" title="映射端口"></a>映射端口</h3><p>内网端口选择服务器对外提供服务的端口号，如提供SSH服务的22端口，提供VNC远程桌面服务的5900号端口，其他服务同理。</p><p>外部端口选择不太常用的端口，防止端口冲突。</p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731181725495-1603134730-169407690423942.png" alt="image-20220731181707752"></p><h3 id="如何使用-1"><a href="#如何使用-1" class="headerlink" title="如何使用"></a>如何使用</h3><p>首先需要在信息中心申请校园网VPN。若要申请，请自行去官网了解流程或者信息中心咨询。</p><p>登录校园网VPN后，若要使用对应的服务，需使用路由器广域网地址+外部端口的形式。</p><blockquote><p>路由器广域网IP：172.25.135.89</p></blockquote><h3 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h3><p>比如现在不在校内，需要使用VPN来访问实验室服务器的桌面端进行实验办公。且已经设置相应的端口映射如上图所示。</p><p>那么需要在已登录师大VPN的情况下访问下面的IP+端口即可完成，如下图所示。</p><p><img src="/images/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E5%86%85%E7%BD%91%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/2169984-20220731182724784-1218350614-169407690423944.png" alt="image-20220731182706681"></p>]]></content>
      
      
      <categories>
          
          <category> remote </category>
          
      </categories>
      
      
        <tags>
            
            <tag> remote </tag>
            
            <tag> 旁路由 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yolov5源码封装</title>
      <link href="/2023/09/06/yolov5%E6%BA%90%E7%A0%81%E5%B0%81%E8%A3%85/"/>
      <url>/2023/09/06/yolov5%E6%BA%90%E7%A0%81%E5%B0%81%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<center>在某些工程中，处于对源代码的保护，需要对相应的工程源码进行封装，尤其是在神经网络的离线训练中。另外，为方便部署，还需将该网络进行训练的环境一并封装即可直接进行布置而无需在进行各种环境配置</center><span id="more"></span><blockquote><p>封装的方式多种多样，但考虑到封装后的代码迁移能力与封装的繁琐程度，最终选定使用Pyinstaller将yolov5的源代码进行封装，并使用基于pyinstaller的auto-py-to-exe工具。</p><p>参考资料：<a href="https://zhuanlan.zhihu.com/p/130328237">https://zhuanlan.zhihu.com/p/130328237</a></p></blockquote><h2 id="安装auto-py-to-exe"><a href="#安装auto-py-to-exe" class="headerlink" title="安装auto-py-to-exe"></a>安装auto-py-to-exe</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install auto-py-to-exe</span><br></pre></td></tr></table></figure><p>使用auto-py-to-exe进行封装时，由于该工具能够将python环境中的相关依赖库一并打包，以保证在部署机器上无需配置环境直接运行，因此，在进行打包前，最好使用anaconda工具新建一个python环境，仅安装该项目的必要依赖库，并在该conda环境下运行 <code>auto-py-to-exe</code>命令启动该工具。</p><p><img src="/images/yolov5%E6%BA%90%E7%A0%81%E5%B0%81%E8%A3%85/image-20230906093504654.png" alt="image-20230906093504654"></p><h2 id="配置yolov5的启动文件"><a href="#配置yolov5的启动文件" class="headerlink" title="配置yolov5的启动文件"></a>配置yolov5的启动文件</h2><p>一般来说，yolov5常常使用命令行工具（CLI）来启动训练或者推理，不像yolov8一样可以使用ultralytics的model来在python中直接启动训练，但是yolov5中仍提供了python中启动的run函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">**kwargs</span>):</span><br><span class="line">    <span class="comment"># Usage: import train; train.run(data=&#x27;coco128.yaml&#x27;, imgsz=320, weights=&#x27;yolov5m.pt&#x27;)</span></span><br><span class="line">    opt = parse_opt(<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">        <span class="built_in">setattr</span>(opt, k, v)</span><br><span class="line">    main(opt)</span><br><span class="line">    <span class="keyword">return</span> opt</span><br></pre></td></tr></table></figure><p>因此，可通过在方式，在根目录下新建一个trainv5.py的文件来启动所需要的所有训练工具。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.socket_module <span class="keyword">import</span> client_socket</span><br><span class="line"><span class="keyword">from</span> segment <span class="keyword">import</span> train <span class="keyword">as</span> segmentTrain</span><br><span class="line"><span class="keyword">from</span> classify <span class="keyword">import</span> train <span class="keyword">as</span> classifyTrain</span><br><span class="line"><span class="keyword">import</span> train <span class="keyword">as</span> detectTrain</span><br><span class="line"><span class="keyword">import</span> export_1 <span class="keyword">as</span> exp</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    multiprocessing.freeze_support()</span><br><span class="line">    pwd = os.getcwd()</span><br><span class="line">    abs_path = os.path.join(pwd, <span class="string">&#x27;config.yaml&#x27;</span>)</span><br><span class="line">    <span class="comment"># 读取 config.yaml 文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(abs_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> config_file:</span><br><span class="line">        config = yaml.safe_load(config_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取 selectMode 属性的值</span></span><br><span class="line">    select_mode = config.get(<span class="string">&#x27;selectMode&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据 selectMode 的不同值，读取相应的第二级属性值</span></span><br><span class="line">    <span class="keyword">if</span> select_mode == <span class="string">&#x27;segment&#x27;</span>:</span><br><span class="line">        segment_properties = config.get(<span class="string">&#x27;segment&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            segmentTrain.run(**segment_properties)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_message = <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(error_message)</span><br><span class="line">            client_socket.sendall(error_message.encode())</span><br><span class="line">            client_socket.close() </span><br><span class="line">    <span class="keyword">elif</span> select_mode == <span class="string">&#x27;detect&#x27;</span>:</span><br><span class="line">        detect_properties = config.get(<span class="string">&#x27;detect&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            detectTrain.run(**detect_properties)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_message = <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(error_message)</span><br><span class="line">            client_socket.sendall(error_message.encode())</span><br><span class="line">            client_socket.close()    </span><br><span class="line">    <span class="keyword">elif</span> select_mode == <span class="string">&#x27;classify&#x27;</span>:</span><br><span class="line">        classify_properties = config.get(<span class="string">&#x27;classify&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            classifyTrain.run(**classify_properties)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_message = <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(error_message)</span><br><span class="line">            client_socket.sendall(error_message.encode())</span><br><span class="line">            client_socket.close()  </span><br><span class="line">    <span class="keyword">elif</span> select_mode == <span class="string">&#x27;export&#x27;</span>:</span><br><span class="line">        export_properties = config.get(<span class="string">&#x27;export&#x27;</span>, &#123;&#125;)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            exp.run(**export_properties)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_message = <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(error_message)</span><br><span class="line">            client_socket.sendall(error_message.encode())</span><br><span class="line">            client_socket.close() </span><br><span class="line">    client_socket.close() </span><br><span class="line">    </span><br></pre></td></tr></table></figure><h3 id="运行时与主进程通信"><a href="#运行时与主进程通信" class="headerlink" title="运行时与主进程通信"></a>运行时与主进程通信</h3><p>在封装后由于整个代码不可调试，因此需要设计一些用于和主进程进行通信的模块，该项目中使用套接字方式与主进程进行通信，在utils目录下新建<code>socket_module.py</code>模块启动套接字客户端，相对应的服务端在后面解释。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># create TP/ICP socket</span></span><br><span class="line">server_address = (<span class="string">&#x27;localhost&#x27;</span>, <span class="number">3334</span>)</span><br><span class="line">client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">client_socket.connect(server_address)</span><br></pre></td></tr></table></figure><p>在该方式中，可以将<code>train.py</code>中相关数据从训练进程中通过套接字的方式传输出来，主进程中的套接字服务端进行接收。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">send_epoch_message = (<span class="string">&quot;当前使用设备：&quot;</span> + <span class="string">&#x27;%-11s&#x27;</span> + <span class="string">&quot;已迭代轮次：&quot;</span> + <span class="string">&#x27;%-11s&#x27;</span> + <span class="string">&quot;预计剩余：&quot;</span> + <span class="string">&#x27;%-11s&#x27;</span> + <span class="string">&quot;单次迭代平均耗时：&quot;</span> + <span class="string">&#x27;%-11s&#x27;</span> + <span class="string">&quot;验证集精准率：&quot;</span> + <span class="string">&#x27;%-11.4f&#x27;</span> + <span class="string">&quot;验证集召回率：&quot;</span> + <span class="string">&#x27;%-11.4f&#x27;</span>) % (device, <span class="string">f&#x27;<span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;epochs&#125;</span>&#x27;</span>, <span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">int</span>(remain_time // <span class="number">3600</span>)&#125;</span>h<span class="subst">&#123;<span class="built_in">int</span>((remain_time % <span class="number">3600</span>) // <span class="number">60</span>)&#125;</span>m<span class="subst">&#123;<span class="built_in">int</span>(remain_time % <span class="number">60</span>)&#125;</span>s&#x27;</span>, <span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">int</span>(epoch_time // <span class="number">3600</span>)&#125;</span>h<span class="subst">&#123;<span class="built_in">int</span>((epoch_time % <span class="number">3600</span>) // <span class="number">60</span>)&#125;</span>m<span class="subst">&#123;<span class="built_in">int</span>(epoch_time % <span class="number">60</span>)&#125;</span>s&#x27;</span>, metrics_dict[<span class="string">&#x27;metrics/precision(B)&#x27;</span>], metrics_dict[<span class="string">&#x27;metrics/recall(B)&#x27;</span>])</span><br><span class="line">client_socket.sendall(send_epoch_message.encode())</span><br></pre></td></tr></table></figure><p>如上述方式中，将使用设备，迭代轮次，预计剩余时间等信息传输到服务端进行训练精度的监控，同时还可在<code>trainv5.py</code>中使用套接字传输训练报错日志，如下所示。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据 selectMode 的不同值，读取相应的第二级属性值</span></span><br><span class="line"><span class="keyword">if</span> select_mode == <span class="string">&#x27;segment&#x27;</span>:</span><br><span class="line">    segment_properties = config.get(<span class="string">&#x27;segment&#x27;</span>, &#123;&#125;)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        segmentTrain.run(**segment_properties)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_message = <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(error_message)</span><br><span class="line">        client_socket.sendall(error_message.encode())</span><br><span class="line">        client_socket.close() </span><br></pre></td></tr></table></figure><h3 id="防止不必要的联网与gitpython出错"><a href="#防止不必要的联网与gitpython出错" class="headerlink" title="防止不必要的联网与gitpython出错"></a>防止不必要的联网与gitpython出错</h3><ul><li>解决gitpython报错</li></ul><p>在运行封装过后的<code>.exe</code>文件时，yolov5在运行的过程中会启用git的check检查，并且试图在新部署机器的命令行中运行，但由于yolov5运行时已经将其依赖的环境全部封装在一起，并不会在新机器中再次安装环境，因此会报错。而离线环境中，我们并不关心yolov5的版本如何，也无需进行下载。</p><p>下面找到相关训练工具，如<code>train.py</code>，<code>/segment/train.py</code>等文件，注释以下语句。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GIT_INFO = check_git_info()</span></span><br><span class="line">ckpt = &#123;</span><br><span class="line">    <span class="string">&#x27;epoch&#x27;</span>: epoch,</span><br><span class="line">    <span class="string">&#x27;best_fitness&#x27;</span>: best_fitness,</span><br><span class="line">    <span class="string">&#x27;model&#x27;</span>: deepcopy(de_parallel(model)).half(),</span><br><span class="line">    <span class="string">&#x27;ema&#x27;</span>: deepcopy(ema.ema).half(),</span><br><span class="line">    <span class="string">&#x27;updates&#x27;</span>: ema.updates,</span><br><span class="line">    <span class="string">&#x27;optimizer&#x27;</span>: optimizer.state_dict(),</span><br><span class="line">    <span class="string">&#x27;opt&#x27;</span>: <span class="built_in">vars</span>(opt),</span><br><span class="line">    <span class="comment"># &#x27;git&#x27;: GIT_INFO,  # &#123;remote, branch, commit&#125; if a git repo</span></span><br><span class="line">    <span class="string">&#x27;date&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># check_git_status()</span></span><br><span class="line"><span class="comment"># check_requirements(ROOT / &#x27;requirements.txt&#x27;)</span></span><br></pre></td></tr></table></figure><ul><li>AMP检查联网</li></ul><p>在进行amp检查时，尤其是在网络情况不好时，常常导致启动速度过慢，因此，删除该检查中的下载模块以加快启动速度，需修改的文件为<code>utils/genenal.py</code>的check_amp函数，替换一下语句。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># im = f if f.exists() else &#x27;https://ultralytics.com/images/bus.jpg&#x27; if check_online() else np.ones((640, 640, 3))</span></span><br><span class="line">im = f <span class="keyword">if</span> f.exists() <span class="keyword">else</span> np.ones((<span class="number">640</span>, <span class="number">640</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure><h3 id="多进程封装问题"><a href="#多进程封装问题" class="headerlink" title="多进程封装问题"></a>多进程封装问题</h3><p>在 Windows 系统上，<code>multiprocessing</code> 模块在执行多进程程序时会创建一个新的 Python 进程，这个新的进程会重新导入和执行主程序（包括你的多进程代码），这可能会导致问题，因为在主程序中执行的一些初始化代码可能会再次执行，导致冲突或错误。</p><p>为了解决这个问题，<code>multiprocessing.freeze_support()</code> 函数应该在主程序的入口点处调用。这个函数的作用是检查当前的进程是否是 “frozen” 进程，如果是，就不再执行初始化代码，从而避免问题。如果不是 “frozen” 进程（通常是在正常运行时），则函数不会执行任何操作，只是简单地返回。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    multiprocessing.freeze_support()</span><br></pre></td></tr></table></figure><h3 id="读取训练图像的多进程问题"><a href="#读取训练图像的多进程问题" class="headerlink" title="读取训练图像的多进程问题"></a>读取训练图像的多进程问题</h3><p>在使用dataloader时，yolov5会调用<code>utils/dataloaders.py</code>中的<code>loadImagesAndLabels</code>类下的如下代码块。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check cache</span></span><br><span class="line">self.label_files = img2label_paths(self.im_files)  <span class="comment"># labels</span></span><br><span class="line">cache_path = (p <span class="keyword">if</span> p.is_file() <span class="keyword">else</span> Path(self.label_files[<span class="number">0</span>]).parent).with_suffix(<span class="string">&#x27;.cache&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cache, exists = np.load(cache_path, allow_pickle=<span class="literal">True</span>).item(), <span class="literal">True</span>  <span class="comment"># load dict</span></span><br><span class="line">    <span class="keyword">assert</span> cache[<span class="string">&#x27;version&#x27;</span>] == self.cache_version  <span class="comment"># matches current version</span></span><br><span class="line">    <span class="keyword">assert</span> cache[<span class="string">&#x27;hash&#x27;</span>] == get_hash(self.label_files + self.im_files)  <span class="comment"># identical hash</span></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    cache, exists = self.cache_labels(cache_path, prefix), <span class="literal">False</span>  <span class="comment"># run cache ops</span></span><br></pre></td></tr></table></figure><p>该方法会先读取训练集或验证集中的cache文件，并对version与hash值进行比对，如果无法对应，则会运行<code>cache_labels</code>方法重新生成cache文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cache_labels</span>(<span class="params">self, path=Path(<span class="params"><span class="string">&#x27;./labels.cache&#x27;</span></span>), prefix=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="comment"># Cache dataset labels, check images and read shapes</span></span><br><span class="line">    x = &#123;&#125;  <span class="comment"># dict</span></span><br><span class="line">    nm, nf, ne, nc, msgs = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, []  <span class="comment"># number missing, found, empty, corrupt, messages</span></span><br><span class="line">    desc = <span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>Scanning <span class="subst">&#123;path.parent / path.stem&#125;</span>...&#x27;</span></span><br><span class="line">    <span class="comment"># with Pool(NUM_THREADS) as pool:</span></span><br><span class="line">    <span class="keyword">with</span> Pool(<span class="number">1</span>) <span class="keyword">as</span> pool:</span><br><span class="line">        pbar = tqdm(pool.imap(verify_image_label, <span class="built_in">zip</span>(self.im_files, self.label_files, repeat(prefix))),</span><br><span class="line">                    desc=desc,</span><br><span class="line">                    total=<span class="built_in">len</span>(self.im_files),</span><br><span class="line">                    bar_format=TQDM_BAR_FORMAT)</span><br><span class="line">        <span class="keyword">for</span> im_file, lb, shape, segments, nm_f, nf_f, ne_f, nc_f, msg <span class="keyword">in</span> pbar:</span><br><span class="line">            nm += nm_f</span><br><span class="line">            nf += nf_f</span><br><span class="line">            ne += ne_f</span><br><span class="line">            nc += nc_f</span><br><span class="line">            <span class="keyword">if</span> im_file:</span><br><span class="line">                x[im_file] = [lb, shape, segments]</span><br><span class="line">                <span class="keyword">if</span> msg:</span><br><span class="line">                    msgs.append(msg)</span><br><span class="line">                    pbar.desc = <span class="string">f&#x27;<span class="subst">&#123;desc&#125;</span> <span class="subst">&#123;nf&#125;</span> images, <span class="subst">&#123;nm + ne&#125;</span> backgrounds, <span class="subst">&#123;nc&#125;</span> corrupt&#x27;</span></span><br><span class="line"></span><br><span class="line">                    pbar.close()</span><br><span class="line">                    <span class="keyword">if</span> msgs:</span><br><span class="line">                        LOGGER.info(<span class="string">&#x27;\n&#x27;</span>.join(msgs))</span><br><span class="line">                        <span class="keyword">if</span> nf == <span class="number">0</span>:</span><br><span class="line">                            LOGGER.warning(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>WARNING ⚠️ No labels found in <span class="subst">&#123;path&#125;</span>. <span class="subst">&#123;HELP_URL&#125;</span>&#x27;</span>)</span><br><span class="line">                            x[<span class="string">&#x27;hash&#x27;</span>] = get_hash(self.label_files + self.im_files)</span><br><span class="line">                            x[<span class="string">&#x27;results&#x27;</span>] = nf, nm, ne, nc, <span class="built_in">len</span>(self.im_files)</span><br><span class="line">                            x[<span class="string">&#x27;msgs&#x27;</span>] = msgs  <span class="comment"># warnings</span></span><br><span class="line">                            x[<span class="string">&#x27;version&#x27;</span>] = self.cache_version  <span class="comment"># cache version</span></span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                np.save(path, x)  <span class="comment"># save cache for next time</span></span><br><span class="line">                                path.with_suffix(<span class="string">&#x27;.cache.npy&#x27;</span>).rename(path)  <span class="comment"># remove .npy suffix</span></span><br><span class="line">                                LOGGER.info(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>New cache created: <span class="subst">&#123;path&#125;</span>&#x27;</span>)</span><br><span class="line">                            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                                LOGGER.warning(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>WARNING ⚠️ Cache directory <span class="subst">&#123;path.parent&#125;</span> is not writeable: <span class="subst">&#123;e&#125;</span>&#x27;</span>)  <span class="comment"># not writeable</span></span><br><span class="line">                                <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p>在上述cache_labels的方式实现中，启用了<code>multiprocessing</code>的线程池，而在封装后的<code>.exe</code>文件执行时，该段代码执行出错，因此在这段代码中，将线程的数量设置为1避免该错误。经测试，在训练集不大的情况下，在加载时并不会导致明显的效率降低。</p><h3 id="训练执行的多进程问题"><a href="#训练执行的多进程问题" class="headerlink" title="训练执行的多进程问题"></a>训练执行的多进程问题</h3><p>在代码的执行过程中，dataloader的numworkers通常用来设置多进程处理的工作线程数，而在封装的过程中，该问题同样会导致程序无法正常运行，该问题和上面的问题类似，应当是会有能够完美运行的方式，但由于时间关系，我仍选择使用最简单的方式，尽快会对效率造成一定的影响。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> loader(dataset,</span><br><span class="line">              batch_size=batch_size,</span><br><span class="line">              shuffle=shuffle <span class="keyword">and</span> sampler <span class="keyword">is</span> <span class="literal">None</span>,</span><br><span class="line">              <span class="comment">#   num_workers=nw,</span></span><br><span class="line">              num_workers=<span class="number">0</span>,</span><br><span class="line">              sampler=sampler,</span><br><span class="line">              pin_memory=PIN_MEMORY,</span><br><span class="line">              collate_fn=LoadImagesAndLabels.collate_fn4 <span class="keyword">if</span> quad <span class="keyword">else</span> LoadImagesAndLabels.collate_fn,</span><br><span class="line">              worker_init_fn=seed_worker,</span><br><span class="line">              generator=generator), dataset</span><br></pre></td></tr></table></figure><p>yolov5源码中全局搜索numworkers，将该项全部置0。</p><blockquote><p>值得注意的是，如果涉及到yolov8的封装，启动文件如果在根目录下，其会调用源码中的<code>dataloader.py</code>执行，如果启动文件在其他目录下，在训练时其会由于无法检索到相关文件而调用ultralytics库中的<code>dataloader.py</code>，因此，如果不在源码根目录下对启动文件打包，那么请务必修改pip安装第三方ultralytics库中的源码。</p></blockquote><h2 id="使用auto-py-to-exe进行封装"><a href="#使用auto-py-to-exe进行封装" class="headerlink" title="使用auto-py-to-exe进行封装"></a>使用auto-py-to-exe进行封装</h2><blockquote><p>Auto PY to EXE 是一个用户友好的图形界面工具，用于将 Python 脚本转换为独立的可执行文件（.exe）或可执行脚本，以便在 Windows 上运行，而无需安装 Python 解释器。以下是 Auto PY to EXE 中的一些主要功能选项：</p></blockquote><ol><li><strong>Script</strong>: 这是指您要转换的 Python 脚本文件的位置。您可以单击 “Browse” 按钮选择您的 Python 脚本文件。</li><li><strong>One Directory</strong>: 这个选项允许您将所有生成的文件保存在一个目录中，以便简化项目结构。</li><li><strong>Console Window</strong>: 如果您的 Python 脚本需要控制台窗口（命令行界面）来与用户交互，则选择此选项。否则，如果脚本是一个 GUI 应用程序，则取消选择此选项。</li><li><strong>Window based (hide the console)</strong>: 如果您的 Python 脚本是一个 GUI 应用程序，但希望在运行时隐藏控制台窗口，可以选择此选项。</li><li><strong>Disable console (no output)</strong>: 如果您的 Python 脚本是一个 GUI 应用程序且不会产生任何控制台输出，可以选择此选项以完全禁用控制台窗口。</li><li><strong>Add a custom icon</strong>: 这个选项允许您为生成的可执行文件指定一个自定义图标。</li><li><strong>Additional Files</strong>: 如果您的 Python 脚本依赖于其他文件，如数据文件、配置文件等，可以在这里添加这些附加文件，以便它们也包含在生成的可执行文件中。</li><li><strong>Excluded Modules</strong>: 如果您希望排除某些 Python 模块（库）以减小生成的可执行文件的大小，可以在这里指定这些模块。</li><li><strong>Zip Dependencies</strong>: 这个选项允许您将依赖项压缩成一个 Zip 文件，以减小可执行文件的大小。</li><li><strong>Advanced</strong>: 在 “Advanced” 选项卡中，您可以进行更高级的配置，如指定自定义 Python 解释器、设置环境变量等。</li><li><strong>Logs</strong>: 这个选项允许您启用详细的日志记录，以便在转换过程中出现问题时进行故障排除。</li><li><strong>Compile</strong>: 最后，单击 “Compile” 按钮开始将 Python 脚本转换为可执行文件的过程。</li></ol><p>以下为我在进行封装时的config文件。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto-py-to-exe-configuration_v1&quot;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;pyinstallerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;noconfirm&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filenames&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;E:/yolov5/trainv5.py&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;onefile&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;console&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trainv5_logE&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ascii&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;clean_build&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strip&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;noupx&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;disable_windowed_traceback&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;embed_manifest&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uac_admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uac_uiaccess&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;win_private_assemblies&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;win_no_prefer_redirects&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bootloader_ignore_signals&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;argv_emulation&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;datas&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Code/Anaconda3/envs/yolov5env/Lib/site-packages/ultralytics/yolo/cfg/default.yaml;./ultralytics/yolo/cfg&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;datas&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/Code/Anaconda3/envs/yolov5env/Lib/site-packages/orderedmultidict/__version__.py;./orderedmultidict&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;optionDest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;datas&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;E:/yolov5/data/hyps;./data/hyps/&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;nonPyinstallerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;increaseRecursionLimit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;manualArguments&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在图形化界面中的选项如下图所示。</p><p><img src="/images/yolov5%E6%BA%90%E7%A0%81%E5%B0%81%E8%A3%85/image-20230906103456448.png" alt="image-20230906103456448"></p><blockquote><p>值得注意的是，在Additional Files部分，所需要添加的文件均为在封装时，根据运行时的报错提示进行追加，其原因是在进行封装时，封装后的根目录发生改变，源码中有些使用绝对路径的文件或者因为其他的原因导致部分文件搜索不到，需要根据提示将其添加到相应的目录下。</p></blockquote><p>该项目将整个工程封装为一个文件夹而不是封装成一个文件，其原因在于封装成一个文件会导致其将相关的动态库和环境全部压缩，在执行该文件时还要先进行解压从而导致启动非常缓慢，因此将其封装为文件夹的形式，动态库均存在于文件夹下，调用方便无需进行解压。</p><p><img src="/images/yolov5%E6%BA%90%E7%A0%81%E5%B0%81%E8%A3%85/image-20230906104231256.png" alt="image-20230906104231256"></p><p>执行<code>.exe</code>文件即可运行。</p><h2 id="进程调用"><a href="#进程调用" class="headerlink" title="进程调用"></a>进程调用</h2><h3 id="配置套接字服务端"><a href="#配置套接字服务端" class="headerlink" title="配置套接字服务端"></a>配置套接字服务端</h3><p>在调用封装后的yolov5中，由于训练程序和调用程序属于两个不同的进程，仅此接收信息需要用到套接字通信，前面已经在训练的源码中配置完套接字的客户端，现在进行套接字的服务端配置以接收消息。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ServerLogThread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line"></span><br><span class="line">    SOCKET serverSocket = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    sockaddr_in serverAddress;</span><br><span class="line">    serverAddress.sin_family = AF_INET;</span><br><span class="line">    serverAddress.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    serverAddress.sin_port = <span class="built_in">htons</span>(<span class="number">3334</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(serverSocket, (<span class="keyword">struct</span> sockaddr*)&amp;serverAddress, <span class="built_in">sizeof</span>(serverAddress));</span><br><span class="line">    <span class="built_in">listen</span>(serverSocket, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Waiting for a connection...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    SOCKET clientSocket = <span class="built_in">accept</span>(serverSocket, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Connected!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> previousBuffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">char</span> currentBuffer[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(previousBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(previousBuffer));</span><br><span class="line">    <span class="built_in">memset</span>(currentBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(currentBuffer));</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> clientConnected = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(clientConnected)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(currentBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(currentBuffer));</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> bytesReceived = <span class="built_in">recv</span>(clientSocket, currentBuffer, <span class="built_in">sizeof</span>(currentBuffer), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (bytesReceived == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Client has closed the connection</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Client has closed the connection.&quot;</span> &lt;&lt; endl;</span><br><span class="line">            clientConnected = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytesReceived &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(previousBuffer, currentBuffer) != <span class="number">0</span>) &#123;</span><br><span class="line">            std::cout &lt;&lt; currentBuffer &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">strcpy</span>(previousBuffer, currentBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(clientSocket);</span><br><span class="line">    <span class="built_in">closesocket</span>(serverSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="yaml文件配置训练参数"><a href="#yaml文件配置训练参数" class="headerlink" title="yaml文件配置训练参数"></a>yaml文件配置训练参数</h3><p>为保证在调用进程时不直接向该执行文件传参，在上述源码的启动文件的设计中，即是用yaml文件的读取来获得yolov5的运行参数，因此，在调用该封装文件前，需要对yaml文件的参数进行配置，C++中使用<code>yaml-cpp</code>库来完成。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        YAML::Node config = YAML::<span class="built_in">LoadFile</span>(<span class="string">&quot;config.yaml&quot;</span>);  </span><br><span class="line"></span><br><span class="line">        std::string selectedMode = config[<span class="string">&quot;selectMode&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line"></span><br><span class="line">        std::string modeInput;</span><br><span class="line">        std::<span class="built_in">getline</span>(std::cin, modeInput);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!modeInput.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            config[<span class="string">&quot;selectMode&quot;</span>] = modeInput;</span><br><span class="line">            selectedMode = modeInput;</span><br><span class="line">            <span class="function">std::ofstream <span class="title">modifiedConfig</span><span class="params">(<span class="string">&quot;config.yaml&quot;</span>)</span></span>;</span><br><span class="line">            modifiedConfig &lt;&lt; config;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;No mode settings provided&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (selectedMode == <span class="string">&quot;segment&quot;</span> || selectedMode == <span class="string">&quot;detect&quot;</span> || selectedMode == <span class="string">&quot;classify&quot;</span>) &#123;</span><br><span class="line">            YAML::Node modeSettings = config[selectedMode];</span><br><span class="line"></span><br><span class="line">            std::cout &lt;&lt; selectedMode &lt;&lt; <span class="string">&quot; Settings:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; keyValue : modeSettings) &#123;</span><br><span class="line">                std::string key = keyValue.first.<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">                std::string value = keyValue.second.<span class="built_in">as</span>&lt;std::string&gt;();</span><br><span class="line">                std::cout &lt;&lt; key &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Enter new settings for &quot;</span> &lt;&lt; selectedMode &lt;&lt; <span class="string">&quot; (key=value pairs separated by space): &quot;</span>;</span><br><span class="line">            std::string modifyInput;</span><br><span class="line">            std::<span class="built_in">getline</span>(std::cin, modifyInput);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!modifyInput.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                <span class="function">std::istringstream <span class="title">iss</span><span class="params">(modifyInput)</span></span>;</span><br><span class="line">                std::string newKey, newValue;</span><br><span class="line">                <span class="keyword">while</span> (std::<span class="built_in">getline</span>(iss, newKey, <span class="string">&#x27;=&#x27;</span>)) &#123;</span><br><span class="line">                    std::<span class="built_in">getline</span>(iss, newValue, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (!newValue.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                        modeSettings[newKey] = newValue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function">std::ofstream <span class="title">modifiedConfig</span><span class="params">(<span class="string">&quot;config.yaml&quot;</span>)</span></span>;</span><br><span class="line">                modifiedConfig &lt;&lt; config;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;Updated configuration saved to config.yaml&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;No new settings provided. Configuration remains unchanged.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Invalid selectMode specified.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> YAML::Exception&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中<code>config.yaml</code>的配置如下所示，可进行多种形式的训练与文件导出，其具体功能实现参考启动文件中代码部分。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selectMode:</span> <span class="string">segment</span></span><br><span class="line"><span class="attr">segment:</span></span><br><span class="line">  <span class="attr">weights:</span> <span class="string">yolov5s-seg.pt</span></span><br><span class="line">  <span class="attr">data:</span> <span class="string">D:/Code/autopy2exeTest/datasets/coco128-seg/coco128-sg.yaml</span></span><br><span class="line">  <span class="attr">epochs:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">imgsz:</span> <span class="number">640</span></span><br><span class="line"><span class="attr">detect:</span></span><br><span class="line">  <span class="attr">weights:</span> <span class="string">yolov5n.pt</span></span><br><span class="line">  <span class="attr">data:</span> <span class="string">D:/Code/autopy2exeTest/datasets/Mask-Wearing-19/data.yaml</span></span><br><span class="line">  <span class="attr">epochs:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">batch_size:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">classify:</span></span><br><span class="line">  <span class="attr">model:</span> <span class="string">yolov5s-cls.pt</span></span><br><span class="line">  <span class="attr">data:</span> <span class="string">cifar100</span></span><br><span class="line">  <span class="attr">epochs:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">img:</span> <span class="number">224</span></span><br><span class="line"><span class="attr">export:</span></span><br><span class="line">  <span class="attr">weights:</span> <span class="string">yolov5n.pt</span></span><br><span class="line">  <span class="attr">include:</span> [<span class="string">onnx</span>]</span><br><span class="line">  <span class="attr">device:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="调用训练进程"><a href="#调用训练进程" class="headerlink" title="调用训练进程"></a>调用训练进程</h3><p>在主进程中新建子进程调用封装后的yolov5进行训练。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;yaml-cpp/yaml.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXEPATH <span class="string">&quot;D:/Code/autopy2exeTest/trainv5_logE/trainv5_logE.exe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ServerLogThread</span><span class="params">()</span></span>;     <span class="comment">// 输出日志</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateConfig</span><span class="params">()</span></span>;        <span class="comment">// 更新配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 要启动的 .exe 文件路径</span></span><br><span class="line">    TCHAR szCommandLine[] = <span class="built_in">TEXT</span>(EXEPATH);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进程启动信息</span></span><br><span class="line">    STARTUPINFO startupInfo;</span><br><span class="line">    PROCESS_INFORMATION processInfo;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;startupInfo, <span class="number">0</span>, <span class="built_in">sizeof</span>(startupInfo));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;processInfo, <span class="number">0</span>, <span class="built_in">sizeof</span>(processInfo));</span><br><span class="line">    startupInfo.cb = <span class="built_in">sizeof</span>(startupInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新配置文件</span></span><br><span class="line">    <span class="built_in">updateConfig</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动server log线程</span></span><br><span class="line">    <span class="function">thread <span class="title">serverLogThread</span><span class="params">(ServerLogThread)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动.exe 文件</span></span><br><span class="line">    BOOL success = <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_NO_WINDOW, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;startupInfo, &amp;processInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="comment">// 进程启动成功</span></span><br><span class="line">        <span class="comment">// 可以使用 processInfo.hProcess 来控制和监视进程</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Process start success.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(processInfo.hProcess, INFINITE);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Process finished.&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="comment">// 关闭句柄</span></span><br><span class="line">        <span class="built_in">CloseHandle</span>(processInfo.hProcess);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(processInfo.hThread);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 进程启动失败</span></span><br><span class="line">        DWORD error = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Process start failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该部分使用windows中的<code>CreateProcess</code>来启用一个子进程，并且使用<code>WaitForSingleObject</code>方式等待其执行完成。由于在等待时会导致主线程阻塞，因此在启动子进程之前，还需要创建一个线程用来执行套接字的服务端，并不断地接收消息并显示。</p>]]></content>
      
      
      <categories>
          
          <category> yolo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> yolo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Typora与hexo编写Blog</title>
      <link href="/2023/09/06/%E4%BD%BF%E7%94%A8Typora%E4%B8%8Ehexo%E7%BC%96%E5%86%99Blog/"/>
      <url>/2023/09/06/%E4%BD%BF%E7%94%A8Typora%E4%B8%8Ehexo%E7%BC%96%E5%86%99Blog/</url>
      
        <content type="html"><![CDATA[<center>Typora作为一款简单易上手的md编写工具，界面简洁美观，本人一直非常喜爱。之前我的Blog均部署在博客园，但是现在因为一些原因导致图片上传非常不便，因此，继续转而在Hexo部署，本文主要着重于解决Typora和Hexo之间存在的图片路径与上传问题。</center><span id="more"></span><h2 id="nodejs版本问题"><a href="#nodejs版本问题" class="headerlink" title="nodejs版本问题"></a>nodejs版本问题</h2><blockquote><p>hexo4.2.0中不支持更高14+更高级的nodejs，因此需要将nodejs版本降级，使用工具nvm来进行操作</p><p>参考链接：<a href="https://juejin.cn/post/7094576504243224612">https://juejin.cn/post/7094576504243224612</a>  <a href="https://github.com/coreybutler/nvm-windows/releases">nvm下载</a></p></blockquote><p>安装命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm install 12.17.0</span><br></pre></td></tr></table></figure><p>使用命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm use 12.17.0</span><br></pre></td></tr></table></figure><p>查看nodejs版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm -v</span><br></pre></td></tr></table></figure><p>查看hexo版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">hexo --version</span><br><span class="line">hexo: 4.2.0</span><br><span class="line">hexo-cli: 4.3.1</span><br><span class="line">os: win32 10.0.23486</span><br><span class="line">node: 12.17.0</span><br><span class="line">v8: 7.8.279.23-node.37</span><br><span class="line">uv: 1.37.0</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">brotli: 1.0.7</span><br><span class="line">ares: 1.16.0</span><br><span class="line">modules: 72</span><br><span class="line">nghttp2: 1.40.0</span><br><span class="line">napi: 6</span><br><span class="line">llhttp: 2.0.4</span><br><span class="line">http_parser: 2.9.3</span><br><span class="line">openssl: 1.1.1g</span><br><span class="line">cldr: 37.0</span><br><span class="line">icu: 67.1</span><br><span class="line">tz: 2019c</span><br><span class="line">unicode: 13.0</span><br></pre></td></tr></table></figure><h2 id="Typora与hexo图像路径问题"><a href="#Typora与hexo图像路径问题" class="headerlink" title="Typora与hexo图像路径问题"></a>Typora与hexo图像路径问题</h2><p>解决的原理很简单，上传时将图片资源放到&#x2F;source&#x2F;images下，在Typora中使用相对路径即可。</p><p>在截图粘贴时，保证复制一份图片到images下的同名文件中即可。设置Typora的偏好，如下所示。</p><p><img src="/images/%E4%BD%BF%E7%94%A8Typora%E4%B8%8Ehexo%E7%BC%96%E5%86%99Blog/image-20230907140422423.png" alt="image-20230907140422423"></p><p>同时为保证其使用相对路径，需设置图片的根目录在source下。其具体设置方式为<strong>格式</strong>-&gt;<strong>图像</strong>-&gt;<strong>设置图片根目录</strong>。</p><p>最好在创建md文件时即可执行该项设置，因此在模板中增加以下一项。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">title<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> title <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">date<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> date <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">commends<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">categories<span class="punctuation">:</span></span><br><span class="line">tags<span class="punctuation">:</span></span><br><span class="line">typora-root-url<span class="punctuation">:</span> ..</span><br></pre></td></tr></table></figure><h2 id="butterfly主题"><a href="#butterfly主题" class="headerlink" title="butterfly主题"></a>butterfly主题</h2><h3 id="hexo版本升级"><a href="#hexo版本升级" class="headerlink" title="hexo版本升级"></a>hexo版本升级</h3><blockquote><p>要求hexo升级到v5.3.0及更高的版本。</p><p>参考资料：<a href="https://novnan.github.io/Hexo/update_hexo/#:~:text=Hexo%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97%20%E5%8F%91%E8%A1%A8%E4%BA%8E%202020-08-07%20%E6%9B%B4%E6%96%B0%E4%BA%8E%202022-03-08%20%E5%88%86%E7%B1%BB%E4%BA%8E%20Hexo%20Hexo,npm-check%20%E3%80%81%20npm-upgrade%20%E3%80%81%20npm-update%20%E4%B8%80%E9%94%AE%E4%B8%89%E8%BF%9E%E3%80%82%20%E6%8C%89%E4%BB%A5%E4%B8%8B%E9%A1%BA%E5%BA%8F%E9%80%90%E6%AD%A5%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8CHexo%20%E7%89%88%E6%9C%AC%E5%8F%8A%E7%B3%BB%E7%BB%9F%E6%8F%92%E4%BB%B6%E5%9D%87%E4%BC%9A%E5%8D%87%E7%BA%A7%E5%88%B0%E6%9C%80%E6%96%B0%E3%80%82">Hexo版本升级指南</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hexo version # 查看当前版本</span><br><span class="line">npm -i hexo-cli - g # 全局升级hexo-cli</span><br><span class="line">hexo version</span><br><span class="line">npm install -g npm-check # 安装npm-check</span><br><span class="line">npm-check # 检查系统插件是否需要升级</span><br><span class="line">npm install -g npm-upgrade # 安装npm-upgrade</span><br><span class="line">npm-upgrade # 更新package.json</span><br><span class="line">npm-upgrade -g # 更新全局插件</span><br><span class="line">npm-upgrade --save # 更新系统插件</span><br><span class="line">hexo version # 再次查看版本是否升级成功</span><br></pre></td></tr></table></figure><h3 id="主题配置"><a href="#主题配置" class="headerlink" title="主题配置"></a>主题配置</h3><blockquote><p>参考资料：<a href="https://blog.csdn.net/mjh1667002013/article/details/129290903">Hexo搭建Butterfly主题并快速美化</a> <a href="https://butterfly.js.org/">Butterfly官网教程</a></p></blockquote><h3 id="随机文章封面"><a href="#随机文章封面" class="headerlink" title="随机文章封面"></a>随机文章封面</h3><blockquote><p>参考资料：<a href="https://blog.mitsumune.top/2023/02/13/hexo_butterfly%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0%E5%AF%B9%E9%9A%8F%E6%9C%BA%E5%9B%BE%E7%89%87api%E7%9A%84%E6%94%AF%E6%8C%81/">hexo butterfly主题添加对随机图片api的支持</a></p></blockquote><p>在<code>butterfly/scipts</code>下新建<code>random_img.js</code>文件，在hexo渲染之前执行过滤器，加载图像。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Butterfly</span></span><br><span class="line"><span class="comment"> * ramdom cover</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(<span class="string">&#x27;before_post_render&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; config &#125; = <span class="variable language_">this</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">post_asset_folder</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> imgTestReg = <span class="regexp">/\.(png|jpe?g|gif|svg|webp)(\?.*)?$/</span></span><br><span class="line">    <span class="keyword">const</span> topImg = data.<span class="property">top_img</span></span><br><span class="line">    <span class="keyword">const</span> cover = data.<span class="property">cover</span></span><br><span class="line">    <span class="keyword">if</span> (topImg &amp;&amp; topImg.<span class="title function_">indexOf</span>(<span class="string">&#x27;/&#x27;</span>) === -<span class="number">1</span> &amp;&amp; imgTestReg.<span class="title function_">test</span>(topImg)) data.<span class="property">top_img</span> = data.<span class="property">path</span> + topImg</span><br><span class="line">    <span class="keyword">if</span> (cover &amp;&amp; cover.<span class="title function_">indexOf</span>(<span class="string">&#x27;/&#x27;</span>) === -<span class="number">1</span>) data.<span class="property">cover</span> = data.<span class="property">path</span> + cover</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data.<span class="property">cover</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    data.<span class="property">randomcover</span> = <span class="title function_">randomCover</span>()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  data.<span class="property">cover</span> = data.<span class="property">cover</span> || <span class="title function_">randomCover</span>()</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">randomCover</span> () &#123;</span><br><span class="line">  <span class="keyword">const</span> theme = hexo.<span class="property">theme</span>.<span class="property">config</span></span><br><span class="line">  <span class="keyword">let</span> cover</span><br><span class="line">  <span class="keyword">let</span> num</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (theme.<span class="property">cover</span> &amp;&amp; theme.<span class="property">cover</span>.<span class="property">default_cover</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(theme.<span class="property">cover</span>.<span class="property">default_cover</span>)) &#123;</span><br><span class="line">      cover = theme.<span class="property">cover</span>.<span class="property">default_cover</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      num = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * theme.<span class="property">cover</span>.<span class="property">default_cover</span>.<span class="property">length</span>)</span><br><span class="line">      cover = theme.<span class="property">cover</span>.<span class="property">default_cover</span>[num]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cover = theme.<span class="property">default_top_img</span> || <span class="string">&#x27;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(theme.<span class="property">cover</span>.<span class="property">suffix</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(theme.<span class="property">cover</span>.<span class="property">suffix</span> == <span class="number">1</span>)</span><br><span class="line">      cover = cover + (<span class="string">&quot;?&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">10000</span>))</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(theme.<span class="property">cover</span>.<span class="property">suffix</span> == <span class="number">2</span>)</span><br><span class="line">      cover = cover + (<span class="string">&quot;&amp;&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">10000</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cover</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在butterfly主题文件_config.butterfly.yml中更改conver属性，添加suffix属性。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cover<span class="punctuation">:</span></span><br><span class="line">  # display the cover or not (是否顯示文章封面)</span><br><span class="line">  index_enable<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  aside_enable<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  archives_enable<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  # the position of cover in home page (封面顯示的位置)</span><br><span class="line">  # left/right/both</span><br><span class="line">  position<span class="punctuation">:</span> both</span><br><span class="line">  # When cover is not set<span class="punctuation">,</span> the default cover is displayed (當沒有設置cover時，默認的封面顯示)</span><br><span class="line">  # <span class="number">0</span><span class="punctuation">:</span> 不使用后缀，<span class="number">1</span><span class="punctuation">:</span> 问号加随机数，<span class="number">2</span><span class="punctuation">:</span> &amp;加随机数</span><br><span class="line">  suffix<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  default_cover<span class="punctuation">:</span></span><br><span class="line">    - https<span class="punctuation">:</span><span class="comment">//www.dmoe.cc/random.php</span></span><br><span class="line">    # - https<span class="punctuation">:</span><span class="comment">//t.mwm.moe/bd</span></span><br><span class="line">    # - https<span class="punctuation">:</span><span class="comment">//t.mwm.moe/xhl</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> Typora </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Google_Protocol_Buffer基本使用</title>
      <link href="/2020/01/14/Google-Protocol-Buffer%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
      <url>/2020/01/14/Google-Protocol-Buffer%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<center>Protocol是Google公司内部的混合语言数据标准。</center><center>Protocol Buffers是一种轻便高效的结构化数据存储格式，可以用于结构化数据穿串行化，或者说序列化。它很适合做数据存储或RPC数据交换格式。可用于通讯协议，数据存储等领域的语言无关，平台无关，可扩展的序列化结构数据格式。</center><center>目前提供了C++，Java，Python三种语言的API。</center><span id="more"></span><hr><blockquote><p>我们主要来探究protocol关于C++部分的API，了解这方面知识可能对理解caffe的源码有很大的帮助，因为protocol在caffe中的使用实在是普遍，最常见的namespace caffe即是protoc编译生成的。在这篇文章中我不会做详细的说明，因为在下面的教程和文档中已经说的非常明白了，请自行了解。<br>参考资料：<br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/">https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/</a><br><a href="https://developers.google.com/protocol-buffers/docs/cpptutorial">https://developers.google.com/protocol-buffers/docs/cpptutorial</a></p></blockquote><h2 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h2><p>开发一个简单的helloworld程序，该程序分为两部分，一部分为Writer，第二部分为Reader。Writer负责将一些结构化的数据写入一个磁盘文件，Reader则负责从该磁盘问价中读取结构化数据并打印到屏幕上，实现磁盘的读写操作。  </p><h3 id="定义你的Protocol格式"><a href="#定义你的Protocol格式" class="headerlink" title="定义你的Protocol格式"></a>定义你的Protocol格式</h3><p>创建一个helloworld.proto文件，并编辑</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lm;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">helloworld</span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">string</span> str = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">optional</span> <span class="type">int32</span> opt = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编译-proto文件"><a href="#编译-proto文件" class="headerlink" title="编译.proto文件"></a>编译.proto文件</h3><p>写好了proto文件是不能直接拿来使用的，需要protoc编译生成头文件和cc文件。由于我安装caffe时已经顺便安装了protocol，如果你没有安装，可以去网上自行搜索安装方式。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=$SRC_DIR --cpp_out=$DST_DIR $SRC_DIR/helloworld.proto</span><br></pre></td></tr></table></figure><p><em><strong>-I</strong></em>: 表示编译源文件的目录<br><em><strong>–cpp_out</strong></em>: 输入C++可用的文件<br>这里我们不写这么麻烦，直接将其生成在当前目录下即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc helloworld.proto --cpp_out=./</span><br></pre></td></tr></table></figure><p>现在目录下就有了三个文件，一个为自己写的helloworld.proto，另外两个为protoc编译生成的两个文件，.proto文件改动时，需要重新编译生成文件才会更新。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helloworld.pb.cc  helloworld.pb.h  helloworld.proto</span><br></pre></td></tr></table></figure><h3 id="编写writer和reader"><a href="#编写writer和reader" class="headerlink" title="编写writer和reader"></a>编写writer和reader</h3><p>protoc生成的文件只是提供给我们方法而已，真正的读写操作还是要自己来实现，至于究竟给我们提供那些操作，可以自行去头文件中查询。</p><p>创建writer.cpp，并编辑</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;helloworld.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> lm::helloworld;</span><br><span class="line"><span class="keyword">using</span> std::fstream;</span><br><span class="line"><span class="keyword">using</span> std::ios;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    helloworld msg1;</span><br><span class="line">    msg1.<span class="built_in">set_id</span>(<span class="number">101</span>);</span><br><span class="line">    msg1.<span class="built_in">set_str</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个fstream流</span></span><br><span class="line">    <span class="function">fstream <span class="title">output</span><span class="params">(<span class="string">&quot;./hello&quot;</span>, ios::out | ios::trunc | ios::binary)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将msg1序列化后写入fsteam流</span></span><br><span class="line">    <span class="keyword">if</span>(!msg1.<span class="built_in">SerializeToOstream</span>(&amp;output))&#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to write msg. &quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建reader.cpp，并编辑</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;helloworld.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> lm::helloworld;</span><br><span class="line"><span class="keyword">using</span> std::fstream;</span><br><span class="line"><span class="keyword">using</span> std::ios;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ListMsg</span><span class="params">(<span class="type">const</span> helloworld &amp;msg)</span></span>&#123;</span><br><span class="line">    std::cout&lt;&lt;msg.<span class="built_in">id</span>()&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt;msg.<span class="built_in">str</span>()&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    helloworld msg1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个输入流</span></span><br><span class="line">    <span class="function">fstream <span class="title">input</span><span class="params">(<span class="string">&quot;./hello&quot;</span>, ios::in | ios::binary)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析输入流</span></span><br><span class="line">    <span class="keyword">if</span>(!msg1.<span class="built_in">ParseFromIstream</span>(&amp;input))&#123;</span><br><span class="line">        std::cerr&lt;&lt;<span class="string">&quot;Failed to parse hello&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ListMsg</span>(msg1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="编译writer-cpp与reader-cpp"><a href="#编译writer-cpp与reader-cpp" class="headerlink" title="编译writer.cpp与reader.cpp"></a>编译writer.cpp与reader.cpp</h3><p>写一个简单的Makefile文件</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">all: writer reader</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"></span><br><span class="line"><span class="section">writer:writer.o helloworld.pb.o</span></span><br><span class="line">g++ -o writer writer.o helloworld.pb.o -lprotobuf</span><br><span class="line"><span class="section">reader:reader.o helloworld.pb.o</span></span><br><span class="line">g++ -o reader reader.o helloworld.pb.o -lprotobuf</span><br><span class="line"></span><br><span class="line"><span class="section">helloworld.pb.o:helloworld.pb.cc</span></span><br><span class="line">g++ -c helloworld.pb.cc</span><br><span class="line"><span class="section">writer.o:writer.cpp helloworld.pb.h</span></span><br><span class="line">g++ -c writer.cpp</span><br><span class="line"><span class="section">reader.o:reader.cpp helloworld.pb.h</span></span><br><span class="line">g++ -c reader.cpp</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm writer reader *.o</span><br></pre></td></tr></table></figure><p>使用<code>make all</code>执行一下Makefile，可以看到生成了两个可执行文件writer和reader。</p><p>.&#x2F;writer运行后产生一个hello文件，该文件为储存磁盘上的二进制文件，再执行.&#x2F;reader输出从hello中读取的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./reader</span><br><span class="line">&gt;101</span><br><span class="line">&gt;hello</span><br></pre></td></tr></table></figure><h2 id="官方指南的栗子"><a href="#官方指南的栗子" class="headerlink" title="官方指南的栗子"></a>官方指南的栗子</h2><h3 id="Define-Your-Protocol-Format"><a href="#Define-Your-Protocol-Format" class="headerlink" title="Define Your Protocol Format"></a>Define Your Protocol Format</h3><blockquote><p><a href="https://developers.google.com/protocol-buffers/docs/cpptutorial">Protocol Buffer Basics:C++</a>有详细的说明</p></blockquote><p>创建一个联系人手册的应用，首先应创建一个.proto的文件，为我们想要序列化的数据结构增加message，为message的每一个成员声明一个名字和类型。我们创建一个<code>addressbook.proto</code>的文件。创建一个联系人<strong>Person</strong> message，当中应该包含联系人的信息<strong>name</strong>, <strong>id</strong>还有可选项<strong>email</strong>，写一个枚举类型，将<strong>PhoneType</strong>限制为<strong>MOBILE</strong>, <strong>HOME</strong>和<strong>WORK</strong>，创建一个嵌套的<strong>PhoneNumber</strong> message，允许一个联系人有多种联系方式，用number记录电话号码，<strong>PhoneType</strong>指定电话类型，最后将定义<strong>phone</strong>表示联系方式的数目，将其设为repeated表示可以设置多个。最后设置一个主角<strong>AddressBook</strong> message，让其可以设置多个联系人。</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="type">string</span> name = <span class="number">1</span>;       <span class="comment">//name</span></span><br><span class="line">    <span class="keyword">required</span> <span class="type">int32</span> id = <span class="number">2</span>;          <span class="comment">//no.</span></span><br><span class="line">    <span class="keyword">optional</span> <span class="type">string</span> email = <span class="number">3</span>;      <span class="comment">//email</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum </span><span class="title class_">PhoneType</span>&#123;</span><br><span class="line">        MOBILE = <span class="number">0</span>;</span><br><span class="line">        HOME = <span class="number">1</span>;</span><br><span class="line">        WORK = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">message </span><span class="title class_">PhoneNumber</span>&#123;</span><br><span class="line">        <span class="keyword">required</span> <span class="type">string</span> number = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">optional</span> PhoneType type = <span class="number">2</span> [default = HOME];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">repeated</span> PhoneNumber phones = <span class="number">4</span>; <span class="comment">//number of phone</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">AdderssBook</span>&#123;</span><br><span class="line">    <span class="keyword">repeated</span> Person people = <span class="number">1</span>;     <span class="comment">//number of person</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Compiling-Your-Protocol-Buffers"><a href="#Compiling-Your-Protocol-Buffers" class="headerlink" title="Compiling Your Protocol Buffers"></a>Compiling Your Protocol Buffers</h3><p>和上面的简单栗子一样，先编译生成C++可以使用的头文件和.cc文件，同样将其放到当前目录下。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc addressbook.proto --cpp_out=./</span><br></pre></td></tr></table></figure><h3 id="The-Protocol-Buffer-API"><a href="#The-Protocol-Buffer-API" class="headerlink" title="The Protocol Buffer API"></a>The Protocol Buffer API</h3><p>如果查看生成的<code>addressbook.pb.h</code>文件的话，你可以看到其为每一个你定义的message都生成了一个类，比如查看看Person类，每一个成员都有一些存取的操作方法。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// name</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">has_name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">clear_name</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">const</span> ::<span class="function">std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_name</span><span class="params">(<span class="type">const</span> ::std::string&amp; value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_name</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* value)</span></span>;</span><br><span class="line"><span class="keyword">inline</span> ::<span class="function">std::string* <span class="title">mutable_name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// id</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">has_id</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">clear_id</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int32_t</span> <span class="title">id</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_id</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// email</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">has_email</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">clear_email</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">const</span> ::<span class="function">std::string&amp; <span class="title">email</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_email</span><span class="params">(<span class="type">const</span> ::std::string&amp; value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">set_email</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* value)</span></span>;</span><br><span class="line"><span class="keyword">inline</span> ::<span class="function">std::string* <span class="title">mutable_email</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// phones</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">phones_size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">clear_phones</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">const</span> ::google::<span class="function">protobuf::RepeatedPtrField&lt; ::tutorial::Person_PhoneNumber &gt;&amp; <span class="title">phones</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">inline</span> ::google::<span class="function">protobuf::RepeatedPtrField&lt; ::tutorial::Person_PhoneNumber &gt;* <span class="title">mutable_phones</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">const</span> ::<span class="function">tutorial::Person_PhoneNumber&amp; <span class="title">phones</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">inline</span> ::<span class="function">tutorial::Person_PhoneNumber* <span class="title">mutable_phones</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line"><span class="keyword">inline</span> ::<span class="function">tutorial::Person_PhoneNumber* <span class="title">add_phones</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>至于Writing和Reading部分，感兴趣的可以去官方文档了解，这里不详细赘述了(实在是不想写了，官网上都有…)</p>]]></content>
      
      
      <categories>
          
          <category> caffe </category>
          
      </categories>
      
      
        <tags>
            
            <tag> protocol </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>caffe运行手写体数字识别例程</title>
      <link href="/2020/01/09/caffe%E8%BF%90%E8%A1%8C%E6%89%8B%E5%86%99%E4%BD%93%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB%E4%BE%8B%E7%A8%8B/"/>
      <url>/2020/01/09/caffe%E8%BF%90%E8%A1%8C%E6%89%8B%E5%86%99%E4%BD%93%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB%E4%BE%8B%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<center>如果说还是不确定自己的caffe安装是否成功，完成一个简单的小项目来进行测试。我们使用MNIST数据集来作为训练和测试样本，使用LeNet-5作为训练模型</center><span id="more"></span><h2 id="下载MNIST数据集"><a href="#下载MNIST数据集" class="headerlink" title="下载MNIST数据集"></a>下载MNIST数据集</h2><p>假设我们处在根目录(之后的文件夹操作我们都假定自己处于根目录下)，进入data&#x2F;mnist，可以看到一个get_mnist.sh的脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env sh</span></span><br><span class="line"><span class="comment"># This scripts downloads the mnist data and unzips it.</span></span><br><span class="line"></span><br><span class="line">DIR=<span class="string">&quot;<span class="subst">$( cd <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span> ; pwd -P )</span>&quot;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Downloading...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> fname <span class="keyword">in</span> train-images-idx3-ubyte train-labels-idx1-ubyte t10k-images-idx3-ubyte t10k-labels-idx1-ubyte</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -e <span class="variable">$fname</span> ]; <span class="keyword">then</span></span><br><span class="line">        wget --no-check-certificate http://yann.lecun.com/exdb/mnist/<span class="variable">$&#123;fname&#125;</span>.gz</span><br><span class="line">        gunzip <span class="variable">$&#123;fname&#125;</span>.gz</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>可见该脚本实现从下载地址下载mnist数据集，<code>bash get_mnist.sh</code>执行该脚本，会将该数据集下载到当前目录下，该数据集的格式可以在相关的网站查询得到。</p><p><strong>TRAINING SET LABEL FILE (train-labels-idx1-ubyte):</strong></p><table><thead><tr><th>[offset]</th><th>[type]</th><th>[value]</th><th>[description]</th></tr></thead><tbody><tr><td>0000</td><td>32 bit integer</td><td>0x00000801(2049)</td><td>magic number (MSB first)</td></tr><tr><td>0004</td><td>32 bit integer</td><td>60000</td><td>number of items</td></tr><tr><td>0008</td><td>unsigned byte</td><td>??</td><td>label</td></tr><tr><td>0009</td><td>unsigned byte</td><td>??</td><td>label</td></tr><tr><td>……..</td><td></td><td></td><td></td></tr><tr><td>xxxx</td><td>unsigned byte</td><td>??</td><td>label</td></tr></tbody></table><p><strong>TRAINING SET IMAGE FILE (train-images-idx3-ubyte):</strong></p><table><thead><tr><th>[offset]</th><th>[type]</th><th>[value]</th><th>[description]</th></tr></thead><tbody><tr><td>0000</td><td>32 bit integer</td><td>0x00000803(2051)</td><td>magic number</td></tr><tr><td>0004</td><td>32 bit integer</td><td>60000</td><td>number of images</td></tr><tr><td>0008</td><td>32 bit integer</td><td>28</td><td>number of rows</td></tr><tr><td>0012</td><td>32 bit integer</td><td>28</td><td>number of columns</td></tr><tr><td>0016</td><td>unsigned byte</td><td>??</td><td>pixel</td></tr><tr><td>0017</td><td>unsigned byte</td><td>??</td><td>pixel</td></tr><tr><td>……..</td><td></td><td></td><td></td></tr><tr><td>xxxx</td><td>unsigned byte</td><td>??</td><td>pixel</td></tr></tbody></table><p>测试集格式同样类似</p><h2 id="转换格式为LMDB"><a href="#转换格式为LMDB" class="headerlink" title="转换格式为LMDB"></a>转换格式为LMDB</h2><p>caffe对mnist样例写好了转换格式的代码，将原二进制格式转化为LMDB，在caffe根目录下执行<code>./examples/mnist/create_mnist.sh</code>，会发现在examples&#x2F;mnist&#x2F;mnist_train_lmdb和examples&#x2F;mnist&#x2F;mnist_test_lmdb两个目录，每个目录下都有两个文件：data.lmdb和lock.lmdb，由名称就可以知道一个为LMDB格式的训练集，一个为LMDB格式的测试集。</p><p>可以分析以下脚本了解是如何转换的。用vim打开create_mnist.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env sh</span></span><br><span class="line"><span class="comment"># This script converts the mnist data into lmdb/leveldb format,</span></span><br><span class="line"><span class="comment"># depending on the value assigned to $BACKEND.</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">EXAMPLE=examples/mnist</span><br><span class="line">DATA=data/mnist</span><br><span class="line">BUILD=build/examples/mnist</span><br><span class="line"></span><br><span class="line">BACKEND=<span class="string">&quot;lmdb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating <span class="variable">$&#123;BACKEND&#125;</span>...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将原本examples/mnist中有关train和test的lmdb或leveldb格式的文件删除，重新转换</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$EXAMPLE</span>/mnist_train_<span class="variable">$&#123;BACKEND&#125;</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$EXAMPLE</span>/mnist_test_<span class="variable">$&#123;BACKEND&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用已经写好的转换工具进行类型转换</span></span><br><span class="line"><span class="variable">$BUILD</span>/convert_mnist_data.bin <span class="variable">$DATA</span>/train-images-idx3-ubyte \</span><br><span class="line">  <span class="variable">$DATA</span>/train-labels-idx1-ubyte <span class="variable">$EXAMPLE</span>/mnist_train_<span class="variable">$&#123;BACKEND&#125;</span> --backend=<span class="variable">$&#123;BACKEND&#125;</span></span><br><span class="line"><span class="variable">$BUILD</span>/convert_mnist_data.bin <span class="variable">$DATA</span>/t10k-images-idx3-ubyte \</span><br><span class="line">  <span class="variable">$DATA</span>/t10k-labels-idx1-ubyte <span class="variable">$EXAMPLE</span>/mnist_test_<span class="variable">$&#123;BACKEND&#125;</span> --backend=<span class="variable">$&#123;BACKEND&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Done.&quot;</span></span><br></pre></td></tr></table></figure><p>由上面的脚本可知调用了build&#x2F;examples&#x2F;mnist下的convert_mnist_data.bin的编译成功的二进制工具，之前我们已经知道了make编译后的文件都存放在build目录下，所以我们根据目录的提示可以知道源码应在examples&#x2F;mnist中，其源码应为convert_mnist_data.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This script converts the MNIST dataset to a lmdb (default) or</span></span><br><span class="line"><span class="comment">// leveldb (--backend=leveldb) format used by caffe to load data.</span></span><br><span class="line"><span class="comment">// Usage:</span></span><br><span class="line"><span class="comment">//    convert_mnist_data [FLAGS] input_image_file input_label_file</span></span><br><span class="line"><span class="comment">//                        output_db_file</span></span><br><span class="line"><span class="comment">// The MNIST dataset could be downloaded at</span></span><br><span class="line"><span class="comment">//    http://yann.lecun.com/exdb/mnist/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gflags/gflags.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;glog/logging.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/text_format.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_LEVELDB) &amp;&amp; defined(USE_LMDB)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;leveldb/db.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;leveldb/write_batch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lmdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span>  <span class="comment">// NOLINT(readability/streams)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;boost/scoped_ptr.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;caffe/proto/caffe.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;caffe/util/db.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;caffe/util/format.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_LEVELDB) &amp;&amp; defined(USE_LMDB)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> caffe;  <span class="comment">// NOLINT(build/namespaces)</span></span><br><span class="line"><span class="keyword">using</span> boost::scoped_ptr;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GFALGS工具定义命令行选项，默认值为lmdb，定义方式为: --backend=lmdb</span></span><br><span class="line"><span class="built_in">DEFINE_string</span>(backend, <span class="string">&quot;lmdb&quot;</span>, <span class="string">&quot;The backend for storing the result&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大小端转换。MNIST原始数据文件中32为的整型值为大端存储，C/C++变量为小端存储，因此需要加入转换机制，MNIST文件中的说明为魔数</span></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">swap_endian</span><span class="params">(<span class="type">uint32_t</span> val)</span> </span>&#123;</span><br><span class="line">    val = ((val &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFF00FF00</span>) | ((val &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00FF</span>);</span><br><span class="line">    <span class="keyword">return</span> (val &lt;&lt; <span class="number">16</span>) | (val &gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">convert_dataset</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* image_filename, <span class="type">const</span> <span class="type">char</span>* label_filename,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">char</span>* db_path, <span class="type">const</span> string&amp; db_backend)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Open files</span></span><br><span class="line">  <span class="comment">// 用C++输入文件流以二进制方式打开文件</span></span><br><span class="line">  <span class="function">std::ifstream <span class="title">image_file</span><span class="params">(image_filename, std::ios::in | std::ios::binary)</span></span>;</span><br><span class="line">  <span class="function">std::ifstream <span class="title">label_file</span><span class="params">(label_filename, std::ios::in | std::ios::binary)</span></span>;</span><br><span class="line">  <span class="comment">// CHECK宏来自于google的glog库，类似于标准库中的assert宏</span></span><br><span class="line">  <span class="comment">// 给定条件不满时终止程序，条件不满时输出后面程序</span></span><br><span class="line">  <span class="built_in">CHECK</span>(image_file) &lt;&lt; <span class="string">&quot;Unable to open file &quot;</span> &lt;&lt; image_filename;</span><br><span class="line">  <span class="built_in">CHECK</span>(label_file) &lt;&lt; <span class="string">&quot;Unable to open file &quot;</span> &lt;&lt; label_filename;</span><br><span class="line">  <span class="comment">// Read the magic and the meta data</span></span><br><span class="line">  <span class="type">uint32_t</span> magic;</span><br><span class="line">  <span class="type">uint32_t</span> num_items;</span><br><span class="line">  <span class="type">uint32_t</span> num_labels;</span><br><span class="line">  <span class="type">uint32_t</span> rows;</span><br><span class="line">  <span class="type">uint32_t</span> cols;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read()是以字符的类型读取，而MNIST的魔数由32位整型组成，并且使用大端存储</span></span><br><span class="line">  <span class="comment">// 应读4个字符共32位，read()将4个字符读取到magic地址的缓存中</span></span><br><span class="line">  <span class="comment">// 必要时进行强制类型转换，并将其转换为小端存储。总条目数，行数，列数同样如此</span></span><br><span class="line">  image_file.<span class="built_in">read</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;magic), <span class="number">4</span>);</span><br><span class="line">  magic = <span class="built_in">swap_endian</span>(magic);</span><br><span class="line">  <span class="comment">// 将大端存储转换为小端存储后</span></span><br><span class="line">  <span class="comment">// 使用同样来自于Glog的CHECK_EQ来判断其是否与2051相等</span></span><br><span class="line">  <span class="comment">// 标签文件则要判断其是否与2049相等</span></span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(magic, <span class="number">2051</span>) &lt;&lt; <span class="string">&quot;Incorrect image file magic.&quot;</span>;</span><br><span class="line">  label_file.<span class="built_in">read</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;magic), <span class="number">4</span>);</span><br><span class="line">  magic = <span class="built_in">swap_endian</span>(magic);</span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(magic, <span class="number">2049</span>) &lt;&lt; <span class="string">&quot;Incorrect label file magic.&quot;</span>;</span><br><span class="line">  image_file.<span class="built_in">read</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;num_items), <span class="number">4</span>);</span><br><span class="line">  num_items = <span class="built_in">swap_endian</span>(num_items);</span><br><span class="line">  label_file.<span class="built_in">read</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;num_labels), <span class="number">4</span>);</span><br><span class="line">  num_labels = <span class="built_in">swap_endian</span>(num_labels);</span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(num_items, num_labels);</span><br><span class="line">  image_file.<span class="built_in">read</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;rows), <span class="number">4</span>);</span><br><span class="line">  rows = <span class="built_in">swap_endian</span>(rows);</span><br><span class="line">  image_file.<span class="built_in">read</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;cols), <span class="number">4</span>);</span><br><span class="line">  cols = <span class="built_in">swap_endian</span>(cols);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function">scoped_ptr&lt;db::DB&gt; <span class="title">db</span><span class="params">(db::GetDB(db_backend))</span></span>;</span><br><span class="line">  db-&gt;<span class="built_in">Open</span>(db_path, db::NEW);</span><br><span class="line">  <span class="function">scoped_ptr&lt;db::Transaction&gt; <span class="title">txn</span><span class="params">(db-&gt;NewTransaction())</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Storing to db</span></span><br><span class="line">  <span class="comment">// 将数据存储到db中</span></span><br><span class="line">  <span class="type">char</span> label;</span><br><span class="line">  <span class="type">char</span>* pixels = <span class="keyword">new</span> <span class="type">char</span>[rows * cols];</span><br><span class="line">  <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">  string value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Datum是caffe.proto定义的message，这里用来存储图片</span></span><br><span class="line">  <span class="comment">// 由于image_file是采用unsigned byte类型，Datum中也有相似的bytes类型</span></span><br><span class="line">  <span class="comment">// 因此这里采用data来进行存取，Datum也支持float类型的数据</span></span><br><span class="line">  <span class="comment">// C++里没有byte类型，但是有与之相似的char类型，用其保存byte</span></span><br><span class="line">  Datum datum;</span><br><span class="line">  datum.<span class="built_in">set_channels</span>(<span class="number">1</span>);</span><br><span class="line">  datum.<span class="built_in">set_height</span>(rows);</span><br><span class="line">  datum.<span class="built_in">set_width</span>(cols);</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;A total of &quot;</span> &lt;&lt; num_items &lt;&lt; <span class="string">&quot; items.&quot;</span>;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Rows: &quot;</span> &lt;&lt; rows &lt;&lt; <span class="string">&quot; Cols: &quot;</span> &lt;&lt; cols;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> item_id = <span class="number">0</span>; item_id &lt; num_items; ++item_id) &#123;</span><br><span class="line">    image_file.<span class="built_in">read</span>(pixels, rows * cols);</span><br><span class="line">    label_file.<span class="built_in">read</span>(&amp;label, <span class="number">1</span>);</span><br><span class="line">    datum.<span class="built_in">set_data</span>(pixels, rows*cols);</span><br><span class="line">    datum.<span class="built_in">set_label</span>(label);</span><br><span class="line">    string key_str = caffe::format_int(item_id, <span class="number">8</span>);</span><br><span class="line">    datum.<span class="built_in">SerializeToString</span>(&amp;value);</span><br><span class="line"></span><br><span class="line">    txn-&gt;<span class="built_in">Put</span>(key_str, value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (++count % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">      txn-&gt;<span class="built_in">Commit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// write the last batch</span></span><br><span class="line">  <span class="keyword">if</span> (count % <span class="number">1000</span> != <span class="number">0</span>) &#123;</span><br><span class="line">      txn-&gt;<span class="built_in">Commit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Processed &quot;</span> &lt;&lt; count &lt;&lt; <span class="string">&quot; files.&quot;</span>;</span><br><span class="line">  <span class="keyword">delete</span>[] pixels;</span><br><span class="line">  db-&gt;<span class="built_in">Close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> GFLAGS_GFLAGS_H_</span></span><br><span class="line">  <span class="keyword">namespace</span> gflags = google;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  FLAGS_alsologtostderr = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  gflags::<span class="built_in">SetUsageMessage</span>(<span class="string">&quot;This script converts the MNIST dataset to\n&quot;</span></span><br><span class="line">        <span class="string">&quot;the lmdb/leveldb format used by Caffe to load data.\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Usage:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    convert_mnist_data [FLAGS] input_image_file input_label_file &quot;</span></span><br><span class="line">        <span class="string">&quot;output_db_file\n&quot;</span></span><br><span class="line">        <span class="string">&quot;The MNIST dataset could be downloaded at\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    http://yann.lecun.com/exdb/mnist/\n&quot;</span></span><br><span class="line">        <span class="string">&quot;You should gunzip them after downloading,&quot;</span></span><br><span class="line">        <span class="string">&quot;or directly use data/mnist/get_mnist.sh\n&quot;</span>);</span><br><span class="line">  gflags::<span class="built_in">ParseCommandLineFlags</span>(&amp;argc, &amp;argv, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FLAGS_backend在前面通过DEFINE_string定义，是字符串类型</span></span><br><span class="line">  <span class="type">const</span> string&amp; db_backend = FLAGS_backend;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">4</span>) &#123;</span><br><span class="line">    gflags::<span class="built_in">ShowUsageWithFlagsRestrict</span>(argv[<span class="number">0</span>],</span><br><span class="line">        <span class="string">&quot;examples/mnist/convert_mnist_data&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    google::<span class="built_in">InitGoogleLogging</span>(argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">convert_dataset</span>(argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>], db_backend);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">LOG</span>(FATAL) &lt;&lt; <span class="string">&quot;This example requires LevelDB and LMDB; &quot;</span> &lt;&lt;</span><br><span class="line">  <span class="string">&quot;compile with USE_LEVELDB and USE_LMDB.&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// USE_LEVELDB and USE_LMDB</span></span></span><br></pre></td></tr></table></figure><p>数据类型多种多样，不可能用一套代码实现所有类型输入数据的读取。转化成统一格式可以简化数据读取层的实现，另一方面，使用LMDB可以提高磁盘的IO利用率。</p><p>接下来我们用LeNet-5模型来进行训练，原版的LeNet-5模型稍有不同，比如将激活函数由Sigmoid改为ReLU，该模型存放在examples&#x2F;mnist&#x2F;lenet_train_test.prototxt中。使用python&#x2F;draw_net.py可以查看网络结构。</p><h2 id="训练超参数"><a href="#训练超参数" class="headerlink" title="训练超参数"></a>训练超参数</h2><p>caffe也为该例程提供了训练的超参数和脚本，查看examples&#x2F;mnist&#x2F;train_lenet.sh脚本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env sh</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">./build/tools/caffe train --solver=examples/mnist/lenet_solver.prototxt <span class="variable">$@</span></span><br></pre></td></tr></table></figure><p>该脚本使用了build&#x2F;tools&#x2F;caffe.bin的二进制程序(caffe是指向caffe.bin的)，并且使用examples&#x2F;mnist&#x2F;lenet_solver.prototxt作为求解器。</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># The train/test net protocol buffer definition</span><br><span class="line">net: <span class="string">&quot;examples/mnist/lenet_train_test.prototxt&quot;</span></span><br><span class="line"># test_iter specifies how many forward passes the test should carry out.</span><br><span class="line"># In the case of MNIST, we have test batch size <span class="number">100</span> and <span class="number">100</span> test iterations,</span><br><span class="line"># covering the full <span class="number">10</span>,<span class="number">000</span> testing images.</span><br><span class="line">test_iter: <span class="number">100</span></span><br><span class="line"># Carry out testing every <span class="number">500</span> training iterations.</span><br><span class="line">test_interval: <span class="number">500</span></span><br><span class="line"># The base learning rate, momentum and the weight decay of the network.</span><br><span class="line">base_lr: <span class="number">0.01</span></span><br><span class="line">momentum: <span class="number">0.9</span></span><br><span class="line">weight_decay: <span class="number">0.0005</span></span><br><span class="line"># The learning rate policy|学习速率的衰减策略</span><br><span class="line">lr_policy: <span class="string">&quot;inv&quot;</span></span><br><span class="line">gamma: <span class="number">0.0001</span></span><br><span class="line">power: <span class="number">0.75</span></span><br><span class="line"># Display every <span class="number">100</span> iterations|每经过<span class="number">100</span>次迭代，在屏幕上打印一次运行log</span><br><span class="line">display: <span class="number">100</span></span><br><span class="line"># The maximum number of iterations</span><br><span class="line">max_iter: <span class="number">10000</span></span><br><span class="line"># snapshot intermediate results|每<span class="number">5000</span>次迭代打印一次快照</span><br><span class="line">snapshot: <span class="number">5000</span></span><br><span class="line">snapshot_prefix: <span class="string">&quot;examples/mnist/lenet&quot;</span></span><br><span class="line"># solver mode: CPU or GPU|Caffe求解为CPU模式。可以改为GPU模式</span><br><span class="line">solver_mode: GPU</span><br></pre></td></tr></table></figure><p>执行脚本后会在examples&#x2F;mnist下生成四个文件，因为每5000次迭代会生成一次快照。具体caffe的运作机制可以在tools&#x2F;caffe.cpp源代码中查看。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lenet_iter_10000.caffemodel</span><br><span class="line">lenet_iter_10000.solverstate</span><br><span class="line">lenet_iter_5000.caffemodel</span><br><span class="line">lenet_iter_5000.solverstate</span><br></pre></td></tr></table></figure><p>在测试中我们选择的模型依旧为lenet_train_test.prototxt，它既包括训练的模型，也包括测试的模型，权重选择迭代10000次后的模型lenet_iter_10000.caffemodel，选择100次迭代为一个batch，100个batch刚好可以测试完10000张图片，并且使用指定的gpu进行测试。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build/tools/caffe test -model examples/mnist/lenet_train_test.prototxt -weights examples/mnist/lenet_iter_10000.caffemodel -iterations 100 -gpu 0</span><br></pre></td></tr></table></figure><p>效果如下所示，正确率达到了99.07%。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">I0116 17:55:27.196736 13017 caffe.cpp:309] Loss: 0.0284669</span><br><span class="line">I0116 17:55:27.196743 13017 caffe.cpp:321] accuracy = 0.9907</span><br><span class="line">I0116 17:55:27.196750 13017 caffe.cpp:321] loss = 0.0284669 (* 1 = 0.0284669 loss)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> caffe </category>
          
      </categories>
      
      
        <tags>
            
            <tag> caffe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu16.04安装caffe</title>
      <link href="/2019/12/30/ubuntu16-04%E5%AE%89%E8%A3%85caffe/"/>
      <url>/2019/12/30/ubuntu16-04%E5%AE%89%E8%A3%85caffe/</url>
      
        <content type="html"><![CDATA[<center>为什么要使用caffe？很多人可能会这样问我。caffe有高效的cuda/C++实现、Matlab/Python接口、独特的神经网络描述方式、清晰的代码框架...都不是，有时候哪有这么多的理由，只是初见而已，就喜欢上了这个框架。</center><span id="more"></span><hr><blockquote><p>至于为什么要是用ubuntu而不使用centos等等其他linux的发行版，完全是看个人喜好了，我也在centos环境下安装过，甚至还在windows下安装过。linux环境的安装都大同小异，网上寻找较为靠谱的教程跟着安装即可。至于windows环境的安装，我不太推荐。一个是微软有官方版本的caffe，也可以去bvlc的github下载源码,装好之后虽然能在windows环境下运行，但是很多caffe自带的bash工具无法使用，windows的命令我也不是很熟，所以在这里不做推荐。这篇博客里我也只记录一些我觉得比较重要的点，这些内容全靠我在安装之后的回想，可能会有遗漏，仅供参考。</p></blockquote><h2 id="Ubuntu换源"><a href="#Ubuntu换源" class="headerlink" title="Ubuntu换源"></a>Ubuntu换源</h2><p>如果你已经换过国内源了，或者是觉得官方源对你来说没有影响，那么此条内容可以跳过。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/apt     # 进入apt目录</span><br><span class="line">sudo cp sources.list sources.list.bak   # 将原来的源进行备份</span><br><span class="line">sudo vim sources.list      # 由于我们已经做好了备份，直接将里面内容替换即可，如果是桌面版也可以用gedit，较为方便</span><br></pre></td></tr></table></figure><p>我比较推荐阿里云的源，当然也可以换成其他的，网上有很多</p><h3 id="阿里云源"><a href="#阿里云源" class="headerlink" title="阿里云源"></a>阿里云源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deb cdrom:[Ubuntu 16.04 LTS _Xenial Xerus_ - Release amd64 (20160420.1)]/ xenial main restricted</span></span><br><span class="line">deb-src http://archive.ubuntu.com/ubuntu xenial main restricted <span class="comment">#Added by software-properties</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted multiverse universe <span class="comment">#Added by software-properties</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted multiverse universe <span class="comment">#Added by software-properties</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse <span class="comment">#Added by software-properties</span></span><br><span class="line">deb http://archive.canonical.com/ubuntu xenial partner</span><br><span class="line">deb-src http://archive.canonical.com/ubuntu xenial partner</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted multiverse universe <span class="comment">#Added by software-properties</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse</span><br></pre></td></tr></table></figure><h3 id="更新源"><a href="#更新源" class="headerlink" title="更新源"></a>更新源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure><h2 id="安装caffe需要的依赖包"><a href="#安装caffe需要的依赖包" class="headerlink" title="安装caffe需要的依赖包"></a>安装caffe需要的依赖包</h2><blockquote><p><strong>ProtoBuffer</strong> 由Google开发的一种可以实现内存与非易失存储介质交换的协议接口，通俗点来讲就是硬盘等存储文件，参见<a href="https://developers.google.com/protocol-buffers/docs/cpptutorial">protobuffer_C++接口文档</a></p></blockquote><blockquote><p><strong>Boost</strong> 被称为C++准标准库，是一个功能强大，构造精巧，跨平台，开源且免费的库，caffe主要用来解决字符串的运算（或者是我只接触到这里？）。</p></blockquote><blockquote><p><strong>GFLAGS</strong> caffe主要用来进行命令行参数解析的作用，与用户进行交互。</p></blockquote><blockquote><p><strong>GLOG</strong> 由Google开发的用于记录应用程序日志的实用库，提供基于C++标准输入输入流形式的接口，记录时可以选择不同的日志级别，方便将重要日志和普通日志分开。</p></blockquote><blockquote><p><strong>BLAS</strong> caffe主要调用其中的方法做矩阵，向量的计算，最常用的BLAS实现有Intel MKL,ATLAS,OpenBLAS，caffe可以选择其中的任意一种，进入Makefile.config将BLAS有关设置改为BLAS :&#x3D; open即可，表示我们使用OpenBLAS。</p></blockquote><blockquote><p><strong>HDF5</strong> 是美国国家高级计算中心(NCSA)为了满足各种领域研究需求而研制的一种能高效存储和分发科学数据的新型数据格式。caffe的训练模型经常保存为hdf5格式。</p></blockquote><blockquote><p><strong>OpenCV</strong> 世界上最流行的开源计算机视觉库。caffe主要使用opencv来完成一些图像存取和预处理功能。</p></blockquote><blockquote><p><strong>LMDB和LEVELDB</strong> 闪电般的内存映射型数据库管理器(LMDB)，在caffe中的作用主要是提供数据管理。所有的数据都要通过一定的预处理来将其转化为LMDB类型才能被caffe的网络读取。LEVELDB库是caffe早期版本使用的数据存储方式，由Google开发，虽然现在大部分历程都已经使用LMDB代替了LEVELDB，但是为了与以前的版本兼容，仍然将这个库增添到依赖中。当然，我肯定会推荐使用LMDB而避免使用LEVELDB。</p></blockquote><blockquote><p><strong>Snappy</strong> 用来压缩和解压缩的C++库，旨在提供较高的压缩速度和合理的压缩率。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br><span class="line">sudo apt-get install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler</span><br><span class="line">sudo apt-get install --no-install-recommends libboost-all-dev</span><br><span class="line">sudo apt-get install libopenblas-dev liblapack-dev libatlas-base-dev</span><br><span class="line">sudo apt-get install libgflags-dev libgoogle-glog-dev liblmdb-dev</span><br></pre></td></tr></table></figure><p>如果你不喜欢使用ubuntu的apt-get工具自动安装的话，以上的所有依赖包均可以自行下载安装编译。</p><h2 id="安装Nvidia显卡驱动"><a href="#安装Nvidia显卡驱动" class="headerlink" title="安装Nvidia显卡驱动"></a>安装Nvidia显卡驱动</h2><p>我不太推荐CPU版本的caffe，因为计算力过于低下。如果你使用的是ubuntu桌面版，那么直接进入<a href="https://www.nvidia.com/Download/index.aspx">Nvidia官网</a>下载相对应的显卡驱动即可，如果使用的服务器或者是只有命令行的版本，可以使用apt-get的方法来安装，但是考虑到有些显卡的不支持，我推荐使用另一台可以正常访问Nvidia官网的电脑记录下载地址使用wget安装，同样的命令在安装后面的cudnn可能会遇到困难，因为cudnn的下载是需要用户登录的，可能需要在wget命令中填写cookies。</p><p>如果原先有驱动但是不太适合的话，可以先进行卸载，进入驱动所在目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 777 *.run     <span class="comment"># 给执行权限</span></span><br><span class="line">sudo ./NVIDIA-Linux-x86_64-390.59.run --uninstall      <span class="comment"># 使用自带的工具进行卸载</span></span><br></pre></td></tr></table></figure><h3 id="禁用nouveau"><a href="#禁用nouveau" class="headerlink" title="禁用nouveau"></a>禁用nouveau</h3><p>将ubuntu自带显卡驱动加入黑名单。虽然我没遇到过类似的问题，但是如果你碰到了类似于显卡驱动无法安装的情况，不妨试试这种方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/modprobe.d/blacklist-nouveau.conf</span><br></pre></td></tr></table></figure><p>进入后增加如下一条命令，将nouveau加入黑名单</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist nouveau</span><br></pre></td></tr></table></figure><p>更新后重启电脑使其生效</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-initramfs -u</span><br></pre></td></tr></table></figure><p>进入显卡驱动安装目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 777 NVIDIA-Linux-x86_64-xxx.xx.run      <span class="comment"># 主要是给执行权限。将xxx.xx换成安装的驱动版本即可，或者是tab键补全</span></span><br><span class="line">./ NVIDIA-Linux-x86_64-xxx.xx.run</span><br></pre></td></tr></table></figure><p>按照提示完成安装，重启后使用nvidia-smi查看驱动版本及显卡当前状态，有结果表明安装成功。</p><h2 id="安装CUDA"><a href="#安装CUDA" class="headerlink" title="安装CUDA"></a>安装CUDA</h2><p>CUDA是一种由NVIDIA推出的通用并行计算架构，该架构使GPU能够解决复杂的计算问题。同样的，桌面版用户可以直接去<a href="https://developer.nvidia.com/cuda-downloads">CUDA官网</a>安装，具体细节可以参考网上的资料或者是<a href="https://docs.nvidia.com/cuda/">CUDA官方文档</a>，强烈推荐根据官方文档中的步骤进行安装，官方文档中有着非常详细的说明，根据自己的系统选择合适的安装方式即可。</p><p>如果你已经确定了自己的安装版本，那么进入下载页面根据自己的系统选择合适的安装包，假设选择的是runfile，那么下载完成后，根据下载页面的提示，进入该目录执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh cuda_xxx_xxx_linux.run      <span class="comment"># tab补全命令即可</span></span><br></pre></td></tr></table></figure><p>按照提示安装重启即可。</p><p>重启后进入用户根目录下，编辑~&#x2F;.bashrc文件或者是&#x2F;etc&#x2F;bashrc文件，使得打开shell时添加环境变量，根据操作系统不同，~&#x2F;.bashrc和~&#x2F;.profile是用户目录下的环境变量设定，&#x2F;etc&#x2F;bashrc和&#x2F;etc&#x2F;profile是全局环境变量设定，具体设置的区别可以自行了解，这里我们只更改当前用户的环境变量设置。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.bashrc      # 编辑.bashrc</span><br></pre></td></tr></table></figure><p>在末尾添加路径和库(假设我们安装的是cuda10.1)，x86_64-linux-gnu两个动态库貌似是ubuntu16.04单独增加的？不管怎样，也把它们添加进来。”:”是分隔符，可以将这些路径写到一起，但是这样较为方便。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/local/cuda-9.0/bin<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/cuda-9.0/lib64<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure><p>使用source命令执行该脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>检测cuda是否安装成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/cuda-10.1/samples/1_Utilities/deviceQuery</span><br><span class="line">sudo make</span><br><span class="line">./deviceQuery</span><br></pre></td></tr></table></figure><p>正如其名，devicequery是cuda自带的一个样例，用来检测设备，如果能够正确识别到你的所有GPU，那么cuda安装成功。</p><h2 id="安装cuDNN"><a href="#安装cuDNN" class="headerlink" title="安装cuDNN"></a>安装cuDNN</h2><p>使用GPU计算已经比CPU快很多了，但是依旧不满足计算力，那么可不可以在不改变硬件的条件下，使得GPU的计算力得到进一步提升呢？当然可以。为了达到更高的性能，我们可以借助专业加速库cuDNN。我们需要通过<a href="https://developer.nvidia.com/rdp/cudnn-download">网站</a>首先注册为CUDA开发者才能获得下载权限，这个是支持社交账号登陆的。Ubuntu桌面版的用户当然可以直接登录下载，要注意你的cudnn与CUDA版本是对应的，下载相应的linux版本。cuda的版本应以你实际下载的版本为准，nvidia-smi工具查询到的结果只是他建议的cuda版本，与实际下载的版本无关。如果是服务器或者是纯命令行的用户，会发现wget下载时会遇到一些问题，但是可以通过wget实现cookie欺骗来进行下载，有需要的可以自行了解。</p><p>下载完成后将其解压，得到一个cuda文件夹，进入该文件夹执行以下命令，因为cudnn归根到底是cuda的库，所以我们将其头文件和动态库都复制到&#x2F;usr&#x2F;local&#x2F;cuda下。&#x2F;usr&#x2F;local&#x2F;下的cuda是一个软链接，指向我们真正下载的cuda-10.1文件夹。因此我们在配置时尽量使用cuda而不是cuda-10.1，以后安装更换cuda版本时，直接改变cuda的指向即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp lib64/lib* /usr/local/cuda/lib64/</span><br><span class="line">sudo cp include/cudnn.h /usr/local/cuda/include/</span><br></pre></td></tr></table></figure><p>进入&#x2F;usr&#x2F;local&#x2F;cuda&#x2F;lib64文件夹下，更改动态库(假设我们安装的是cudnn 7.6.5)，具体什么原因不太明白。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> -f libcudnn.so libcudnn.so.7</span><br><span class="line">sudo <span class="built_in">ln</span> -s libcudnn.so.7.6.5 libcudnn.so.7</span><br><span class="line">sudo <span class="built_in">ln</span> -s libcudnn.so.7 libcudnn.so</span><br><span class="line">sudo ldconfig   <span class="comment"># 使动态库生效</span></span><br></pre></td></tr></table></figure><p>所以现在的链接关系是libcudnn.so-&gt;libcudnn.so.7-&gt;libcudnn.so.7.6.5</p><h2 id="下载caffe"><a href="#下载caffe" class="headerlink" title="下载caffe"></a>下载caffe</h2><p>使用git下载caffe的github源码，make编译时是根据Makefile.config来编译的，我们复制一份Makefile.config.example并将其命名为Makefile.config，将原来的作为备份。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/bvlc/caffe.git</span><br><span class="line">cd caffe/</span><br><span class="line">cp Makefile.config.example Makefile.config</span><br></pre></td></tr></table></figure><h2 id="Makefile-config文件配置"><a href="#Makefile-config文件配置" class="headerlink" title="Makefile.config文件配置"></a>Makefile.config文件配置</h2><p>主要还是看编译过程中错误怎么报，根据报错来解决比较好，我只是提供一个我自己的配置方法，但是在不同的设备和版本上运行的时候仍有可能报错。</p><p>使用vim编辑Makefile.config文件，cudnn前面的注释取消</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cuDNN acceleration switch (uncomment to build with cuDNN).</span><br><span class="line">USE_CUDNN := 1</span><br></pre></td></tr></table></figure><p>使用<code>pkg-config --modversion opencv</code>查看opencv版本，如果是opencv3的话，将opencv前面的注释取消</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Uncomment if you&#x27;re using OpenCV 3</span><br><span class="line">OPENCV_VERSION := 3</span><br></pre></td></tr></table></figure><p>根据使用的cuda版本注释相应的ARCH，我使用的是10.1，所以删掉了所有的*_20和*_21，就成了下面这个样子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># CUDA architecture setting: going with all of them.</span><br><span class="line"># For CUDA &lt; 6.0, comment the *_50 through *_61 lines for compatibility.</span><br><span class="line"># For CUDA &lt; 8.0, comment the *_60 and *_61 lines for compatibility.</span><br><span class="line"># For CUDA &gt;= 9.0, comment the *_20 and *_21 lines for compatibility.</span><br><span class="line">CUDA_ARCH := -gencode arch=compute_30,code=sm_30 \</span><br><span class="line">                -gencode arch=compute_35,code=sm_35 \</span><br><span class="line">                -gencode arch=compute_50,code=sm_50 \</span><br><span class="line">                -gencode arch=compute_52,code=sm_52 \</span><br><span class="line">                -gencode arch=compute_60,code=sm_60 \</span><br><span class="line">                -gencode arch=compute_61,code=sm_61 \</span><br><span class="line">                -gencode arch=compute_61,code=compute_61</span><br></pre></td></tr></table></figure><p>BLAS我们选择OpenBlas，将其改为open</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># BLAS choice:</span><br><span class="line"># atlas for ATLAS (default)</span><br><span class="line"># mkl for MKL</span><br><span class="line"># open for OpenBlas</span><br><span class="line">BLAS := open</span><br></pre></td></tr></table></figure><p>在命令行状态下使用<code>sudo find / -name hdf5.h</code> 和 <code>sudo find / -name hdf5_hl.h </code>查看hdf5.h和hdf5_hl.h头文件路径，将其添加到Makfile.config中，一般而言应为&#x2F;usr&#x2F;inlucde&#x2F;hdf5&#x2F;serial，动态库也要单独的添加，同样的使用<code>sudo find / -name libhdf5.so</code>，也可以得知它并不在一般的&#x2F;usr&#x2F;lib或者&#x2F;usr&#x2F;local&#x2F;lib中，因此也要单独添加</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Whatever else you find you need goes here.</span><br><span class="line"># Whatever else you find you need goes here.</span><br><span class="line">INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/hdf5/serial</span><br><span class="line">LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial</span><br></pre></td></tr></table></figure><h2 id="Makefile文件配置"><a href="#Makefile文件配置" class="headerlink" title="Makefile文件配置"></a>Makefile文件配置</h2><p>找到LIBRARIES，将我们之前通过apt-get下载的依赖库添加进去</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIBRARIES +=glog gflags protobuf boost_system boost_filesystem m hdf5_serial_hl hdf5_serial</span><br></pre></td></tr></table></figure><p>找到NVCCFALGS，增加预处理和编译时需要的宏-D_FORCE_INLEINES，貌似可以防止nvcc编译出错？不太明白，先添加进去，防止出一些莫名其妙的错误</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NVCCFLAGS += -D_FORCE_INLINES -ccbin=$(CXX) -Xcompiler -fPIC $(COMMON_FLAGS)</span><br></pre></td></tr></table></figure><h2 id="添加动态链接库路径"><a href="#添加动态链接库路径" class="headerlink" title="添加动态链接库路径"></a>添加动态链接库路径</h2><p>感觉有点无关紧要，Makefile.config中会单独指明路径。编辑&#x2F;etc&#x2F;ld.so.conf，添加以下路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include /etc/ld.so.conf.d/*.conf</span><br><span class="line">include /usr/lib</span><br><span class="line">include /usr/local/lib</span><br></pre></td></tr></table></figure><p>执行<code>ldconfig</code>使其生效</p><h2 id="caffe编译"><a href="#caffe编译" class="headerlink" title="caffe编译"></a>caffe编译</h2><p>设置完成后使用<code>make all -j</code>编译，一般来说按照我上面的设置不会遇到问题，如果还是出现了各种各样的问题，按照报的具体错误去研究解决，以下为我安装过程中的出现的一些错误，可供参考。出现错误不要紧，<code>make clean</code>后解决问题在编译即可</p><h3 id="“-warning-“math-functions-h-is-an-internal-header-file-and-must-not-be-used-directly-This-file-will-be-removed-in-a-future-CUDA-release-Please-use-cuda-runtime-api-h-or-cuda-runtime-h-instead-””"><a href="#“-warning-“math-functions-h-is-an-internal-header-file-and-must-not-be-used-directly-This-file-will-be-removed-in-a-future-CUDA-release-Please-use-cuda-runtime-api-h-or-cuda-runtime-h-instead-””" class="headerlink" title="“#warning “math_functions.h is an internal header file and must not be used directly. This file will be removed in a future CUDA release. Please use cuda_runtime_api.h or cuda_runtime.h instead.””"></a>“#warning “math_functions.h is an internal header file and must not be used directly. This file will be removed in a future CUDA release. Please use cuda_runtime_api.h or cuda_runtime.h instead.””</h3><p>根据提示，进入&#x2F;src&#x2F;caffe&#x2F;util&#x2F;math_functions.cu文件中，用cuda_runtime.h头文件代替原来的math_functions.h，高版本的cuda都会用cuda_runtime.h来代替，也可以选择忽视该问题</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#include &lt;math_functions.h&gt;  // CUDA&#x27;s, not caffe&#x27;s, for fabs, signbit</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_runtime.h&gt;</span>  <span class="comment">//cuda10.1 support,not math_functions.h</span></span></span><br></pre></td></tr></table></figure><h3 id="“-usr-bin-ld-cannot-find-lhdf5-hl和-usr-bin-ld-cannot-find-lhdf5”"><a href="#“-usr-bin-ld-cannot-find-lhdf5-hl和-usr-bin-ld-cannot-find-lhdf5”" class="headerlink" title="“&#x2F;usr&#x2F;bin&#x2F;ld: cannot find -lhdf5_hl和&#x2F;usr&#x2F;bin&#x2F;ld: cannot find -lhdf5”"></a>“&#x2F;usr&#x2F;bin&#x2F;ld: cannot find -lhdf5_hl和&#x2F;usr&#x2F;bin&#x2F;ld: cannot find -lhdf5”</h3><p>原因在于找不到hdf5动态库文件，可以使用<code>sudo find / -name libhdf5.so</code>，ubuntu16.04 LTS是将该动态库文件放在&#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;hdf5&#x2F;serial下的，因此我们需在Makefile.config中指明编译时的路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial</span><br></pre></td></tr></table></figure><h2 id="编译完成"><a href="#编译完成" class="headerlink" title="编译完成"></a>编译完成</h2><p>运行<code>make all -j</code>编译不报错即为编译完成，也可以运行<code>make runtest -j</code>来进行测试，测试过程可能较为漫长，请耐心等待。如果没有错误会显示PASSED</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[----------] Global test environment tear-down</span><br><span class="line">[==========] 2207 tests from 285 test cases ran. (270650 ms total)</span><br><span class="line">[  PASSED  ] 2207 tests.</span><br></pre></td></tr></table></figure><p>到此为止caffe安装编译完成，编译好的文件会放到caffe根目录的build文件夹下，其他接口的编译暂不作说明，感兴趣的可以自己去网络上查找资料。</p><p>附上贾扬清博士的caffe介绍：<a href="http://caffe.berkeleyvision.org/">http://caffe.berkeleyvision.org/</a></p>]]></content>
      
      
      <categories>
          
          <category> caffe </category>
          
      </categories>
      
      
        <tags>
            
            <tag> caffe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>markdown的基本使用</title>
      <link href="/2019/12/29/markdown%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/12/29/markdown%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>摘要：Markdown是一种可以使用普通文本编辑器编写的标记语言，通过简单的标记语法，它可以使普通文本内容具有一定的格式。Markdown具有一系列衍生版本，用于扩展Markdown的功能（如表格、脚注、内嵌HTML等等），这些功能原初的Markdown尚不具备，它们能让Markdown转换成更多的格式，例如LaTeX，Docbook。Markdown增强版中比较有名的有Markdown Extra、MultiMarkdown、 Maruku等。这些衍生版本要么基于工具，如Pandoc；要么基于网站，如GitHub和Wikipedia，在语法上基本兼容，但在一些语法和渲染效果上有改动。  –摘自《百度百科》</p><span id="more"></span><h2 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h2><ol><li><p>使用 &#x3D; 和 - 标记一级标题和二级标题 </p><h1 id="我展示的是一级标题"><a href="#我展示的是一级标题" class="headerlink" title=" 我展示的是一级标题"></a> 我展示的是一级标题</h1><h2 id="我展示的是二级标题"><a href="#我展示的是二级标题" class="headerlink" title=" 我展示的是二级标题"></a> 我展示的是二级标题</h2></li><li><p>使用 # 标记</p><h1 id="一级标题"><a href="#一级标题" class="headerlink" title="一级标题"></a>一级标题</h1><h2 id="二级标题"><a href="#二级标题" class="headerlink" title="二级标题"></a>二级标题</h2><h3 id="三级标题"><a href="#三级标题" class="headerlink" title="三级标题"></a>三级标题</h3><h4 id="四级标题"><a href="#四级标题" class="headerlink" title="四级标题"></a>四级标题</h4><h5 id="五级标题"><a href="#五级标题" class="headerlink" title="五级标题"></a>五级标题</h5><h6 id="六级标题"><a href="#六级标题" class="headerlink" title="六级标题"></a>六级标题</h6></li></ol><h2 id="段落格式"><a href="#段落格式" class="headerlink" title="段落格式"></a>段落格式</h2><ol><li><p>段落</p><ul><li>Markdown 段落没有特殊的格式，直接编写文字就好，段落的换行是使用两个以上空格加上回车。</li><li>当然也可以在段落后面使用一个空行来表示重新开始一个段落。</li></ul></li><li><p>字体  </p><ul><li>Markdown可以使用一下几种字体<ul><li><em>斜体文本</em></li><li><em>斜体文本</em></li><li><strong>粗体文本</strong></li><li><strong>粗体文本</strong></li><li><em><strong>斜粗体文本</strong></em></li><li><em><strong>斜粗体文本</strong></em></li></ul></li></ul></li><li><p>分割线</p><ul><li><hr></li><li><hr></li><li><hr></li><li><hr></li><li><hr></li></ul></li></ol><h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><ol><li>无序列表使用星号(*)、加号(+)或是减号(-)作为列表标记：<ul><li>第一项</li><li>第二项</li><li>第三项</li></ul></li><li>有序列表使用数字并加上 . 号来表示，如：<ol><li>第一项</li><li>第二项</li><li>第三项</li></ol></li><li>列表嵌套：列表嵌套只需在子列表中的选项添加四个空格即可：<ol><li>第一项<ul><li>第一项嵌套的第一个元素</li><li>第一项嵌套的第二个元素</li></ul></li><li>第二项<ul><li>第二项嵌套的第一个元素</li><li>第二项嵌套的第二个元素</li></ul></li></ol></li></ol><h2 id="区块"><a href="#区块" class="headerlink" title="区块"></a>区块</h2><ol><li>Markdown 区块引用是在段落开头使用 &gt; 符号 ，然后后面紧跟一个空格符号(换行依旧要加两空格)：<blockquote><p>I am<br>newgoals  </p></blockquote></li><li>区块是可以嵌套的，一个 &gt; 符号是最外层，两个 &gt; 符号是第一层嵌套，以此类推：<blockquote><p>I am newgoals</p><blockquote><p>I love here</p><blockquote><p>and so on</p></blockquote></blockquote></blockquote></li><li>列表中使用区块：this contend is an example.</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><ol><li>如果是段落上的一个函数或片段的代码可以用 <em><strong>反引号</strong></em> 把它包起来（`），例如:<br> <code>printf()</code> 函数</li><li>代码区块使用 4 个空格或者一个制表符（Tab 键）。   <? echo 'hello world!'; function test(){     echo 'test'; }</li><li>你也可以用 (&#96;&#96;&#96;) 包裹一段代码，并指定一种语言（也可以不指定）： <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iosteram&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;hello world! &quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><ol><li>[链接名称](链接地址)<br> this is a link : <a href="http://www.baidu.com/">baidu</a></li><li>&lt;链接地址&gt;<br> this is a link : <a href="http://www.baidu.com/">http://www.baidu.com</a></li><li>高级链接<br> 链接也可以用变量来代替，文档末尾附带变量地址:<br> 这个链接用 1 作为网址变量 <a href="http://www.google.com/">Google</a><br> 这个链接用 baidu 作为网址变量 <a href="http://www.baidu.com/">Baidu</a><br> 然后在文档的结尾为变量赋值（网址）</li></ol><h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><ol><li><p>Markdown 制作表格使用 | 来分隔不同的单元格，使用 - 来分隔表头和其他行。  </p><table><thead><tr><th>表头</th><th>表头</th></tr></thead><tbody><tr><td>单元格</td><td>单元格</td></tr><tr><td>单元格</td><td>单元格</td></tr></tbody></table></li><li><p>我们可以设置表格的对齐方式：</p><ul><li>-: 设置内容和标题栏居右对齐。</li><li>:- 设置内容和标题栏居左对齐。</li><li>:-: 设置内容和标题栏居中对齐。</li></ul><table><thead><tr><th align="left">左对齐</th><th align="right">右对齐</th><th align="center">居中对齐</th></tr></thead><tbody><tr><td align="left">单元格</td><td align="right">单元格</td><td align="center">单元格</td></tr><tr><td align="left">单元格</td><td align="right">单元格</td><td align="center">单元格</td></tr></tbody></table></li></ol><h2 id="高级技巧"><a href="#高级技巧" class="headerlink" title="高级技巧"></a>高级技巧</h2><ol><li>公式：当你需要在编辑器中插入数学公式时，可以使用两个美元符 $$ 包裹 TeX 或 LaTeX 格式的数学公式来实现。提交后，问答和文章页会根据需要加载 Mathjax 对数学公式进行渲染。</li></ol>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录第一次搭建博客</title>
      <link href="/2019/12/29/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/"/>
      <url>/2019/12/29/%E8%AE%B0%E5%BD%95%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<p>摘要：在互联网行业中，个人博客已经是我们在求职路上不可多得的加分项，因此我最近一直在思考一种能够方便，简洁的搭建个人博客的方案。在经过一段时间的摸爬滚打与分析之后我决定使用github page配合hexo的方案来架设自己的博客。主要的原因有两点：其一，完全免费；其二，方便快捷。虽然说我对网页制作有着一点基础，但是并不想太过深入，而是想把有限的时间用在我更想发展的方向，hexo几乎完美的解决了这个问题，能将markdown格式的文档转化成静态网页。至于动态部署的问题，也可以用源码github托管的方式来进行。总的来说，我觉得这算是我目前能想到的最佳解决方案了。</p><span id="more"></span><h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><blockquote><p>网上有很多下载教程，按照步骤和自己的要求一步步来就行</p></blockquote><p><a href="https://gitforwindows.org/">git官网</a></p><h2 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h2><blockquote><p>网上同样有很多下载教程</p></blockquote><p><a href="https://nodejs.org/en/">node.js官网</a></p><h2 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h2><p>查看git，nodejs，npm是否安装成功，如果能显示版本号，则证明安装成功：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git --version</span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure><p>进入git bash，创建blog的本地文件夹：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> Hexo</span><br></pre></td></tr></table></figure><p>在Hexo文件夹下安装hexo，-g表示全局安装，如果对npm不太熟悉的话，建议全局安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo</span><br></pre></td></tr></table></figure><p>如果发现npm安装过慢，我们可以弃用官方源，使用淘宝提供的源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm get registry  <span class="comment"># 查看npm源</span></span><br><span class="line">&gt; https://registry.npmjs.org/</span><br><span class="line"></span><br><span class="line">npm config <span class="built_in">set</span> registry http://registry.npm.taobao.org/  <span class="comment"># 将npm源换成淘宝源</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然也可以换回官方源</span></span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npmjs.org/</span><br></pre></td></tr></table></figure><p>或者是采用另一种方法来设置npm，同样是采用全局安装的方法，但是后续的所有npm命令都需将npm换成cnpm:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cnpm -g --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><h2 id="初始化hexo"><a href="#初始化hexo" class="headerlink" title="初始化hexo"></a>初始化hexo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure><h2 id="hexo配置"><a href="#hexo配置" class="headerlink" title="hexo配置"></a>hexo配置</h2><p><a href="https://hexo.io/zh-cn/docs/index.html">Hexo中文文档</a></p><p><a href="http://theme-next.iissnan.com/">Next主题中文文档</a></p><p><a href="https://hexo-theme-next.netlify.com/">Next主题更新日志</a></p><h3 id="解决”warning-LF-will-be-replaced-by-CRLF”"><a href="#解决”warning-LF-will-be-replaced-by-CRLF”" class="headerlink" title="解决”warning: LF will be replaced by CRLF”"></a>解决”warning: LF will be replaced by CRLF”</h3><p>Windows中的换行符为CRLF，Linux中的换行符为LF.在工作区的文件中，有的是以LF作为换行符结尾的，然后在添加到暂存区的时候，git会暂存区的LF换成CRLF。然后统一提交时候，都是CRLF换行了。</p><p>使用git bash进入git根目录，或者是直接使用git-cmd（git-cmd默认在git根目录下打开），将自动转换禁止。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config –-global core.autocrlf false</span><br></pre></td></tr></table></figure><h3 id="表格显示不出来的问题"><a href="#表格显示不出来的问题" class="headerlink" title="表格显示不出来的问题"></a>表格显示不出来的问题</h3><p>makedown的表格应与上文相隔至少两行才能正确显示。</p><h3 id="修改主站点标题字体和大小"><a href="#修改主站点标题字体和大小" class="headerlink" title="修改主站点标题字体和大小"></a>修改主站点标题字体和大小</h3><p>Next 7.6.0支持直接在主题的_config.yml配置文件中修改的，直接搜索到font定义的区域，将enable设置为true，Next默认将google的字体库作为Next的字体库，当然也可以设为别的字体库，虽然说将其开启后会稍微影响一下网站加载速度，但是为了美观这些事情无关紧要…字体设置中包括很多部分的字体修改，这里我们选择我们需要更改的主站标题字体，先将external设置为true使其加载设置的字体库，在Google字体库中浏览决定自己想要的字体后，将其名称填入family中，对字体大小不满意的话，还可以在size中设置字体，根据提示是以em为单位( 1em&#x3D;16px )：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">font:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uri of fonts host, e.g. //fonts.googleapis.com (Default).</span></span><br><span class="line">  <span class="comment"># host: https://fonts.google.com/</span></span><br><span class="line">  <span class="comment"># Font options:</span></span><br><span class="line">  <span class="comment"># `external: true` will load this font family from `host` above.</span></span><br><span class="line">  <span class="comment"># `family: Times New Roman`. Without any quotes.</span></span><br><span class="line">  <span class="comment"># `size: x.x`. Use `em` as unit. Default: 1 (16px)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Global font settings used for all elements inside &lt;body&gt;.</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Lato</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for site title (.site-title).</span></span><br><span class="line">  <span class="attr">title:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Dancing</span> <span class="string">Script</span></span><br><span class="line">    <span class="attr">size:</span> <span class="number">2.5</span></span><br></pre></td></tr></table></figure><h3 id="字数统计和阅读时长"><a href="#字数统计和阅读时长" class="headerlink" title="字数统计和阅读时长"></a>字数统计和阅读时长</h3><p>Next 7.6.0支持在主题的_config.yml配置文件中设置wordcount功能，根据自己喜好设置。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Post wordcount display settings</span></span><br><span class="line"><span class="comment">## Dependencies: https://github.com/theme-next/hexo-symbols-count-time</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">exclude_codeblock:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>完成了相应的设置还不行，我们还需安装其依赖包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-symbols-count-time</span><br></pre></td></tr></table></figure><h3 id="文章访问量统计"><a href="#文章访问量统计" class="headerlink" title="文章访问量统计"></a>文章访问量统计</h3><p>Next 7.6.0支持在主题的_config.yml配置文件中设置busuanzi_count功能，将enable设置为true，其他根据自己喜好设置即可。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Show Views / Visitors of the website / page with busuanzi.</span></span><br><span class="line"><span class="comment"># Get more information on http://ibruce.info/2015/04/04/busuanzi</span></span><br><span class="line"><span class="attr">busuanzi_count:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">total_visitors_icon:</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">total_views:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">total_views_icon:</span> <span class="string">eye</span></span><br><span class="line">  <span class="attr">post_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post_views_icon:</span> <span class="string">eye</span></span><br></pre></td></tr></table></figure><h3 id="增加背景图片"><a href="#增加背景图片" class="headerlink" title="增加背景图片"></a>增加背景图片</h3><p>在Next 7.6.0主题的_config.yml配置文件中找到custom_file_path自定义文件路径，将style取消注释。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define custom file paths.</span></span><br><span class="line"><span class="comment"># Create your custom files in site directory `source/_data` and uncomment needed files below.</span></span><br><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.swig</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.swig</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.swig</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.swig</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.swig</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.swig</span></span><br><span class="line">  <span class="comment">#bodyEnd: source/_data/body-end.swig</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><p>在主站根目录下新建相应的目录和文件，进入styles.styl进行编辑。</p><figure class="highlight styl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加背景图片</span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">      <span class="attribute">background</span>: <span class="built_in">url</span>(...); <span class="comment">//图片url地址</span></span><br><span class="line">      <span class="attribute">background-size</span>: cover;</span><br><span class="line">      <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">      <span class="attribute">background-attachment</span>: fixed;</span><br><span class="line">      <span class="attribute">background-position</span>: <span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改主体透明度</span></span><br><span class="line"><span class="selector-class">.main-inner</span> &#123;</span><br><span class="line">      <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">      <span class="attribute">opacity</span>: <span class="number">0.8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改菜单栏透明度</span></span><br><span class="line"><span class="selector-class">.header-inner</span> &#123;</span><br><span class="line">      <span class="attribute">opacity</span>: <span class="number">0.8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Hexo源码托管到github"><a href="#Hexo源码托管到github" class="headerlink" title="Hexo源码托管到github"></a>Hexo源码托管到github</h2><blockquote><p>参考博客：<a href="http://www.tiankai.party/posts/63890/">http://www.tiankai.party/posts/63890/</a></p></blockquote><p>首先我们需要知道hexo g &amp;&amp; hexo d的工作原理是什么，根据参数的意思大概知道generate是将makedown文件转换成HTML格式的生成命令，而deploy则是部署，即将HTML通过git提交到github page。但是正如我开始说的，这些源码都是保存在自己电脑中，做不到动态部署，如果我们换一台主机，想写博客的话就会显得束手无策。于是我们可以选择将源码一并托管的方式来达成动态部署的目的。</p><p>首先我们需要分析哪些是需要我们部署的文件，哪些是不需要的，在我们安装一些包或者是实行一些命令时会生成一些文件，而这些文件是无关紧要的，hexo clean之后查看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./   .deploy_git/  .gitignore   node_modules/  package-lock.json  source/</span><br><span class="line">../  .git/         _config.yml  package.json   scaffolds/         themes/</span><br></pre></td></tr></table></figure><p>至于不需要的文件有哪些，***.gitignore*** 中就有一些…当然 <em><strong>.gitignore</strong></em> 本身也是，具体有以下几种:</p><p><em><strong>public</strong></em> 和 <em><strong>.deploy_git</strong></em> 文件是hexo g &amp;&amp; hexo d分别生成的<br><em><strong>node_moudules</strong></em> 文件依赖里有packages.json可以使用npm install生成</p><p>需要提交的文件有以下几种:</p><p><em><strong>scaffolds</strong></em> 里面是模板文件。创建post，page或draft时会使用其中的模板，当然也可以自己预设模板<br><em><strong>source</strong></em> 中保存的是自己博客的md文件，而部署时时不会将md文件一并提交github的，所以我们需要在源码部署中将这些文件上传github<br><em><strong>_config.yml</strong></em> 如果你不想自己的主站设置丢失的话，还是将它传上去比较好<br><em><strong>themes</strong></em> 用来存放下载的主题，不想自己辛辛苦苦配置的主题丢失的话，也需将其一并上传</p><p>由于主题文件是从作者的github账号中clone下来的，所以主题文件的push地址也为作者的git，但是我们只需将其当成普通文件上传即可，因此需要删除.git文件夹，如果有多个主题文件的话，选择你现在使用的themes上传即可。</p><p>在上传之前还需创建一个用来保存源码的仓库，随便取个名字就好。（假设我们处在hexo根目录下）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># next-reloaded是我现在使用的主题</span></span><br><span class="line"><span class="built_in">cd</span> themes/next-reloaded/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看现在主题文件的远程分支，显而易见应该是原作者的仓库，应删除</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="built_in">rm</span> -rf .git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退回至hexo根目录</span></span><br><span class="line"><span class="built_in">cd</span> ../..</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在根目录下初始化git，产生.git文件夹</span></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时git remote -v没有结果的，我们还需添加远程仓库</span></span><br><span class="line">git remote add origin &lt;项目地址&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询远程仓库，如果于你指定的仓库相同就可以push了</span></span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将需要的文件上传</span></span><br><span class="line">git add &lt;自己需要上传的文件&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看上传文件</span></span><br><span class="line">git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加日志 </span></span><br><span class="line">git commit -m <span class="string">&quot;first commit&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并仓库和本地文件</span></span><br><span class="line">git pull origin master --allow-unrelated-histories</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传</span></span><br><span class="line">git push --set-upstream origin master</span><br></pre></td></tr></table></figure><p>在其他机器上部署时，使用git clone将源码下载到本地，在根目录下使用npm install恢复node_modules，在相关依赖安装完成的前提下，即可编辑上传。</p><h3 id="在ubuntu下使用hexo"><a href="#在ubuntu下使用hexo" class="headerlink" title="在ubuntu下使用hexo"></a>在ubuntu下使用hexo</h3><p>首先要保证已经安装了git和nodejs。由于我已经安装了npm，但是版本过低，并且没有node -v查不到node版本号不知道怎么回事。需要重新安装与升级。</p><p>如果node不是最新的，node有一个模块叫n，是专门用来管理node.js的版本的。使用npm（NPM是随同nodejs一起安装的包管理工具）安装n模块。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装n模块</span></span><br><span class="line">sudo npm install -g n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级nodejs到最新稳定版</span></span><br><span class="line">sudo n stable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级npm</span></span><br><span class="line">sudo npm install npm -g</span><br></pre></td></tr></table></figure><p>此时node与npm应该都为最新版，然后使用git将源码pull到本地，并且恢复npm_modules。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone &lt;源码地址&gt;</span><br><span class="line">cd hexo-origin</span><br><span class="line">sudo npm install</span><br></pre></td></tr></table></figure><p>现在即可编辑上传博客了。</p>]]></content>
      
      
      <categories>
          
          <category> blog </category>
          
      </categories>
      
      
        <tags>
            
            <tag> github page </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
